/*
 Platform.js <https://mths.be/platform>
 Copyright 2014-2018 Benjamin Tan <https://bnjmnt4n.now.sh/>
 Copyright 2011-2013 John-David Dalton
 Available under MIT license <https://mths.be/mit>
*/
(function(){var g="undefined"!==typeof window&&"undefined"!==typeof window.document?window.document:{},h="undefined"!==typeof module&&module.exports,f="undefined"!==typeof Element&&"ALLOW_KEYBOARD_INPUT"in Element,e=function(){for(var a,d=["requestFullscreen exitFullscreen fullscreenElement fullscreenEnabled fullscreenchange fullscreenerror".split(" "),"webkitRequestFullscreen webkitExitFullscreen webkitFullscreenElement webkitFullscreenEnabled webkitfullscreenchange webkitfullscreenerror".split(" "),
"webkitRequestFullScreen webkitCancelFullScreen webkitCurrentFullScreenElement webkitCancelFullScreen webkitfullscreenchange webkitfullscreenerror".split(" "),"mozRequestFullScreen mozCancelFullScreen mozFullScreenElement mozFullScreenEnabled mozfullscreenchange mozfullscreenerror".split(" "),"msRequestFullscreen msExitFullscreen msFullscreenElement msFullscreenEnabled MSFullscreenChange MSFullscreenError".split(" ")],c=0,f=d.length,l={};c<f;c++)if((a=d[c])&&a[1]in g){for(c=0;c<a.length;c++)l[d[0][c]]=
a[c];return l}return!1}(),c={change:e.fullscreenchange,error:e.fullscreenerror},a={request:function(a){var b=e.requestFullscreen;a=a||g.documentElement;if(/5\.1[.\d]* Safari/.test(navigator.userAgent))a[b]();else a[b](f&&Element.ALLOW_KEYBOARD_INPUT)},exit:function(){g[e.exitFullscreen]()},toggle:function(a){this.isFullscreen?this.exit():this.request(a)},onchange:function(a){this.on("change",a)},onerror:function(a){this.on("error",a)},on:function(a,d){var b=c[a];b&&g.addEventListener(b,d,!1)},off:function(a,
d){var b=c[a];b&&g.removeEventListener(b,d,!1)},raw:e};e?(Object.defineProperties(a,{isFullscreen:{get:function(){return!!g[e.fullscreenElement]}},element:{enumerable:!0,get:function(){return g[e.fullscreenElement]}},enabled:{enumerable:!0,get:function(){return!!g[e.fullscreenEnabled]}}}),h?module.exports=a:window.screenfull=a):h?module.exports=!1:window.screenfull=!1})();
(function(){function g(a){a=String(a);return a.charAt(0).toUpperCase()+a.slice(1)}function h(a,b){var d=-1,c=a?a.length:0;if("number"==typeof c&&-1<c&&c<=w)for(;++d<c;)b(a[d],d,a);else e(a,b)}function f(a){a=String(a).replace(/^ +| +$/g,"");return/^(?:webOS|i(?:OS|P))/.test(a)?a:g(a)}function e(a,b){for(var d in a)r.call(a,d)&&b(a[d],d,a)}function c(a){return null==a?g(a):B.call(a).slice(8,-1)}function a(a,b){var d=null!=a?typeof a[b]:"number";return!/^(?:boolean|number|string|undefined)$/.test(d)&&
("object"==d?!!a[b]:!0)}function b(a){return String(a).replace(/([ -])(?!$)/g,"$1?")}function d(a,b){var d=null;h(a,function(c,m){d=b(d,c,m,a)});return d}function m(k){function g(a){return d(a,function(a,d){var c=d.pattern||b(d);!a&&(a=RegExp("\\b"+c+" *\\d+[.\\w_]*","i").exec(k)||RegExp("\\b"+c+" *\\w+-[\\w]*","i").exec(k)||RegExp("\\b"+c+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(k))&&((a=String(d.label&&!RegExp(c,"i").test(d.label)?d.label:a).split("/"))[1]&&!/[\d.]+/.test(a[0])&&(a[0]+=
" "+a[1]),d=d.label||d,a=f(a[0].replace(RegExp(c,"i"),d).replace(RegExp("; *(?:"+d+"[_-])?","i")," ").replace(RegExp("("+d+")[-_.]?(\\w)","i"),"$1 $2")));return a})}function h(a){return d(a,function(a,b){return a||(RegExp(b+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(k)||0)[1]||null})}var p=l,q=k&&"object"==typeof k&&"String"!=c(k);q&&(p=k,k=null);var w=p.navigator||{},r=w.userAgent||"";k||(k=r);var E=q?!!w.likeChrome:/\bChrome\b/.test(k)&&!/internal|\n/i.test(B.toString()),
A=q?"Object":"ScriptBridgingProxyObject",L=q?"Object":"Environment",H=q&&p.java?"JavaPackage":c(p.java),Q=q?"Object":"RuntimeObject";L=(H=/\bJava/.test(H)&&p.java)&&c(p.environment)==L;var R=H?"a":"\u03b1",S=H?"b":"\u03b2",M=p.document||{},F=p.operamini||p.opera,I=v.test(I=q&&F?F["[[Class]]"]:c(F))?I:F=null,n,J=k;q=[];var K=null,G=k==r;r=G&&F&&"function"==typeof F.version&&F.version();var x=function(a){return d(a,function(a,d){return a||RegExp("\\b"+(d.pattern||b(d))+"\\b","i").exec(k)&&(d.label||
d)})}([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"]),t=function(a){return d(a,function(a,d){return a||RegExp("\\b"+(d.pattern||b(d))+"\\b","i").exec(k)&&(d.label||d)})}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"Edge"},"Midori","Nook Browser",
"PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Waterfox","WebPositive","Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chrome",{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},
{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),y=g([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad",
"iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),D=function(a){return d(a,function(a,d,c){return a||(d[y]||d[/^[a-z]+(?: +[a-z]+\b)*/i.exec(y)]||RegExp("\\b"+b(c)+"(?:\\b|\\w*\\d)","i").exec(k))&&c})}({Apple:{iPad:1,iPhone:1,iPod:1},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},
"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1}}),u=function(a){return d(a,function(a,d){var c=d.pattern||b(d);if(!a&&(a=RegExp("\\b"+c+"(?:/[\\d.]+|[ \\w.]*)","i").exec(k))){var m=a,l=d.label||d,e={"10.0":"10","6.4":"10 Technical Preview",
"6.3":"8.1","6.2":"8","6.1":"Server 2008 R2 / 7","6.0":"Server 2008 / Vista","5.2":"Server 2003 / XP 64-bit","5.1":"XP","5.01":"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};c&&l&&/^Win/i.test(m)&&!/^Windows Phone /i.test(m)&&(e=e[/[\d.]+$/.exec(m)])&&(m="Windows "+e);m=String(m);c&&l&&(m=m.replace(RegExp(c,"i"),l));a=m=f(m.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/,
" $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}return a})}(["Windows Phone","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian","Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac",
"Windows 98;","Windows "]);x&&(x=[x]);D&&!y&&(y=g([D]));if(n=/\bGoogle TV\b/.exec(y))y=n[0];/\bSimulator\b/i.test(k)&&(y=(y?y+" ":"")+"Simulator");"Opera Mini"==t&&/\bOPiOS\b/.test(k)&&q.push("running in Turbo/Uncompressed mode");"IE"==t&&/\blike iPhone OS\b/.test(k)?(n=m(k.replace(/like iPhone OS/,"")),D=n.manufacturer,y=n.product):/^iP/.test(y)?(t||(t="Safari"),u="iOS"+((n=/ OS ([\d_]+)/i.exec(k))?" "+n[1].replace(/_/g,"."):"")):"Konqueror"!=t||/buntu/i.test(u)?D&&"Google"!=D&&(/Chrome/.test(t)&&
!/\bMobile Safari\b/i.test(k)||/\bVita\b/.test(y))||/\bAndroid\b/.test(u)&&/^Chrome/.test(t)&&/\bVersion\//i.test(k)?(t="Android Browser",u=/\bAndroid\b/.test(u)?u:"Android"):"Silk"==t?(/\bMobi/i.test(k)||(u="Android",q.unshift("desktop mode")),/Accelerated *= *true/i.test(k)&&q.unshift("accelerated")):"PaleMoon"==t&&(n=/\bFirefox\/([\d.]+)\b/.exec(k))?q.push("identifying as Firefox "+n[1]):"Firefox"==t&&(n=/\b(Mobile|Tablet|TV)\b/i.exec(k))?(u||(u="Firefox OS"),y||(y=n[1])):!t||(n=!/\bMinefield\b/i.test(k)&&
/\b(?:Firefox|Safari)\b/.exec(t))?(t&&!y&&/[\/,]|^[^(]+?\)/.test(k.slice(k.indexOf(n+"/")+8))&&(t=null),(n=y||D||u)&&(y||D||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(u))&&(t=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(u)?u:n)+" Browser")):"Electron"==t&&(n=(/\bChrome\/([\d.]+)\b/.exec(k)||0)[1])&&q.push("Chromium "+n):u="Kubuntu";r||(r=h(["(?:Cloud9|CriOS|CrMo|Edge|FxiOS|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$))","Version",b(t),"(?:Firefox|Minefield|NetFront)"]));
if(n="iCab"==x&&3<parseFloat(r)&&"WebKit"||/\bOpera\b/.test(t)&&(/\bOPR\b/.test(k)?"Blink":"Presto")||/\b(?:Midori|Nook|Safari)\b/i.test(k)&&!/^(?:Trident|EdgeHTML)$/.test(x)&&"WebKit"||!x&&/\bMSIE\b/i.test(k)&&("Mac OS"==u?"Tasman":"Trident")||"WebKit"==x&&/\bPlayStation\b(?! Vita\b)/i.test(t)&&"NetFront")x=[n];"IE"==t&&(n=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(k)||0)[1])?(t+=" Mobile",u="Windows Phone "+(/\+$/.test(n)?n:n+".x"),q.unshift("desktop mode")):/\bWPDesktop\b/i.test(k)?(t="IE Mobile",u="Windows Phone 8.x",
q.unshift("desktop mode"),r||(r=(/\brv:([\d.]+)/.exec(k)||0)[1])):"IE"!=t&&"Trident"==x&&(n=/\brv:([\d.]+)/.exec(k))&&(t&&q.push("identifying as "+t+(r?" "+r:"")),t="IE",r=n[1]);if(G){if(a(p,"global"))if(H&&(n=H.lang.System,J=n.getProperty("os.arch"),u=u||n.getProperty("os.name")+" "+n.getProperty("os.version")),L){try{r=p.require("ringo/engine").version.join("."),t="RingoJS"}catch(P){(n=p.system)&&n.global.system==p.system&&(t="Narwhal",u||(u=n[0].os||null))}t||(t="Rhino")}else"object"==typeof p.process&&
!p.process.browser&&(n=p.process)&&("object"==typeof n.versions&&("string"==typeof n.versions.electron?(q.push("Node "+n.versions.node),t="Electron",r=n.versions.electron):"string"==typeof n.versions.nw&&(q.push("Chromium "+r,"Node "+n.versions.node),t="NW.js",r=n.versions.nw)),t||(t="Node.js",J=n.arch,u=n.platform,r=(r=/[\d.]+/.exec(n.version))?r[0]:null));else c(n=p.runtime)==A?(t="Adobe AIR",u=n.flash.system.Capabilities.os):c(n=p.phantom)==Q?(t="PhantomJS",r=(n=n.version||null)&&n.major+"."+n.minor+
"."+n.patch):"number"==typeof M.documentMode&&(n=/\bTrident\/(\d+)/i.exec(k))?(r=[r,M.documentMode],(n=+n[1]+4)!=r[1]&&(q.push("IE "+r[1]+" mode"),x&&(x[1]=""),r[1]=n),r="IE"==t?String(r[1].toFixed(1)):r[0]):"number"==typeof M.documentMode&&/^(?:Chrome|Firefox)\b/.test(t)&&(q.push("masking as "+t+" "+r),t="IE",r="11.0",x=["Trident"],u="Windows");u=u&&f(u)}r&&(n=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(r)||/(?:alpha|beta)(?: ?\d)?/i.exec(k+";"+(G&&w.appMinorVersion))||/\bMinefield\b/i.test(k)&&
"a")&&(K=/b/i.test(n)?"beta":"alpha",r=r.replace(RegExp(n+"\\+?$"),"")+("beta"==K?S:R)+(/\d+\+?/.exec(n)||""));if("Fennec"==t||"Firefox"==t&&/\b(?:Android|Firefox OS)\b/.test(u))t="Firefox Mobile";else if("Maxthon"==t&&r)r=r.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(y))"Xbox 360"==y&&(u=null),"Xbox 360"==y&&/\bIEMobile\b/.test(k)&&q.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(t)&&(!t||y||/Browser|Mobi/.test(t))||"Windows CE"!=u&&!/Mobi/i.test(k))if("IE"==t&&G)try{null===p.external&&
q.unshift("platform preview")}catch(P){q.unshift("embedded")}else(/\bBlackBerry\b/.test(y)||/\bBB10\b/.test(k))&&(n=(RegExp(y.replace(/ +/g," *")+"/([.\\d]+)","i").exec(k)||0)[1]||r)?(n=[n,/BB10/.test(k)],u=(n[1]?(y=null,D="BlackBerry"):"Device Software")+" "+n[0],r=null):this!=e&&"Wii"!=y&&(G&&F||/Opera/.test(t)&&/\b(?:MSIE|Firefox)\b/i.test(k)||"Firefox"==t&&/\bOS X (?:\d+\.){2,}/.test(u)||"IE"==t&&(u&&!/^Win/.test(u)&&5.5<r||/\bWindows XP\b/.test(u)&&8<r||8==r&&!/\bTrident\b/.test(k)))&&!v.test(n=
m.call(e,k.replace(v,"")+";"))&&n.name&&(n="ing as "+n.name+((n=n.version)?" "+n:""),v.test(t)?(/\bIE\b/.test(n)&&"Mac OS"==u&&(u=null),n="identify"+n):(n="mask"+n,t=I?f(I.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(n)&&(u=null),G||(r=null)),x=["Presto"],q.push(n));else t+=" Mobile";if(n=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(k)||0)[1]){n=[parseFloat(n.replace(/\.(\d)$/,".0$1")),n];if("Safari"==t&&"+"==n[1].slice(-1))t="WebKit Nightly",K="alpha",r=n[1].slice(0,-1);else if(r==n[1]||r==(n[2]=
(/\bSafari\/([\d.]+\+?)/i.exec(k)||0)[1]))r=null;n[1]=(/\bChrome\/([\d.]+)/i.exec(k)||0)[1];537.36==n[0]&&537.36==n[2]&&28<=parseFloat(n[1])&&"WebKit"==x&&(x=["Blink"]);G&&(E||n[1])?(x&&(x[1]="like Chrome"),n=n[1]||(n=n[0],530>n?1:532>n?2:532.05>n?3:533>n?4:534.03>n?5:534.07>n?6:534.1>n?7:534.13>n?8:534.16>n?9:534.24>n?10:534.3>n?11:535.01>n?12:535.02>n?"13+":535.07>n?15:535.11>n?16:535.19>n?17:536.05>n?18:536.1>n?19:537.01>n?20:537.11>n?"21+":537.13>n?23:537.18>n?24:537.24>n?25:537.36>n?26:"Blink"!=
x?"27":"28")):(x&&(x[1]="like Safari"),n=(n=n[0],400>n?1:500>n?2:526>n?3:533>n?4:534>n?"4+":535>n?5:537>n?6:538>n?7:601>n?8:"8"));x&&(x[1]+=" "+(n+="number"==typeof n?".x":/[.+]/.test(n)?"":"+"));"Safari"==t&&(!r||45<parseInt(r))&&(r=n)}"Opera"==t&&(n=/\bzbov|zvav$/.exec(u))?(t+=" ",q.unshift("desktop mode"),"zvav"==n?(t+="Mini",r=null):t+="Mobile",u=u.replace(RegExp(" *"+n+"$"),"")):"Safari"==t&&/\bChrome\b/.exec(x&&x[1])&&(q.unshift("desktop mode"),t="Chrome Mobile",r=null,/\bOS X\b/.test(u)?(D=
"Apple",u="iOS 4.3+"):u=null);r&&0==r.indexOf(n=/[\d.]+$/.exec(u))&&-1<k.indexOf("/"+n+"-")&&(u=String(u.replace(n,"")).replace(/^ +| +$/g,""));x&&!/\b(?:Avant|Nook)\b/.test(t)&&(/Browser|Lunascape|Maxthon/.test(t)||"Safari"!=t&&/^iOS/.test(u)&&/\bSafari\b/.test(x[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|Web)/.test(t)&&x[1])&&(n=x[x.length-1])&&q.push(n);q.length&&(q=["("+q.join("; ")+")"]);D&&y&&0>y.indexOf(D)&&q.push("on "+D);y&&q.push((/^on /.test(q[q.length-
1])?"":"on ")+y);if(u){var O=(n=/ ([\d.+]+)$/.exec(u))&&"/"==u.charAt(u.length-n[0].length-1);u={architecture:32,family:n&&!O?u.replace(n[0],""):u,version:n?n[1]:null,toString:function(){var a=this.version;return this.family+(a&&!O?" "+a:"")+(64==this.architecture?" 64-bit":"")}}}(n=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(J))&&!/\bi686\b/i.test(J)?(u&&(u.architecture=64,u.family=u.family.replace(RegExp(" *"+n),"")),t&&(/\bWOW64\b/i.test(k)||G&&/\w(?:86|32)$/.test(w.cpuClass||w.platform)&&!/\bWin64; x64\b/i.test(k))&&
q.unshift("32-bit")):u&&/^OS X/.test(u.family)&&"Chrome"==t&&39<=parseFloat(r)&&(u.architecture=64);k||(k=null);p={};p.description=k;p.layout=x&&x[0];p.manufacturer=D;p.name=t;p.prerelease=K;p.product=y;p.ua=k;p.version=t&&r;p.os=u||{architecture:null,family:null,version:null,toString:function(){return"null"}};p.parse=m;p.toString=function(){return this.description||""};p.version&&q.unshift(r);p.name&&q.unshift(t);u&&t&&(u!=String(u).split(" ")[0]||u!=t.split(" ")[0]&&!y)&&q.push(y?"("+u+")":"on "+
u);q.length&&(p.description=q.join(" "));return p}var k={"function":!0,object:!0},l=k[typeof window]&&window||this,p=k[typeof exports]&&exports;k=k[typeof module]&&module&&!module.nodeType&&module;var q=p&&k&&"object"==typeof global&&global;!q||q.global!==q&&q.window!==q&&q.self!==q||(l=q);var w=Math.pow(2,53)-1,v=/\bOpera/;q=Object.prototype;var r=q.hasOwnProperty,B=q.toString,A=m();"function"==typeof define&&"object"==typeof define.amd&&define.amd?(l.platform=A,define(function(){return A})):p&&
k?e(A,function(a,b){p[b]=a}):l.platform=A}).call(this);
function buildIOSMeta(){for(var g=[{name:"viewport",content:"width=device-width, height=device-height, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"},{name:"apple-mobile-web-app-capable",content:"yes"},{name:"apple-mobile-web-app-status-bar-style",content:"black"}],h=0;h<g.length;h++){var f=document.createElement("meta");f.name=g[h].name;f.content=g[h].content;var e=window.document.head.querySelector('meta[name="'+f.name+'"]');e&&e.parentNode.removeChild(e);window.document.head.appendChild(f)}}
function hideIOSFullscreenPanel(){jQuery(".xxx-ios-fullscreen-message").css("display","none");jQuery(".xxx-ios-fullscreen-scroll").css("display","none");jQuery(".xxx-game-iframe-full").removeClass("xxx-game-iframe-iphone-se")}function buildIOSFullscreenPanel(){jQuery("body").append('<div class="xxx-ios-fullscreen-message"><div class="xxx-ios-fullscreen-swipe"></div></div><div class="xxx-ios-fullscreen-scroll"></div>')}
function showIOSFullscreenPanel(){jQuery(".xxx-ios-fullscreen-message").css("display","block");jQuery(".xxx-ios-fullscreen-scroll").css("display","block")}
function __iosResize(){window.scrollTo(0,0);if("iPhone"===platform.product)switch(window.devicePixelRatio){case 2:switch(window.innerWidth){case 568:320!==window.innerHeight&&jQuery(".xxx-game-iframe-full").addClass("xxx-game-iframe-iphone-se");break;case 667:375===window.innerHeight?hideIOSFullscreenPanel():showIOSFullscreenPanel();break;default:hideIOSFullscreenPanel()}break;case 3:switch(window.innerWidth){case 736:414===window.innerHeight?hideIOSFullscreenPanel():showIOSFullscreenPanel();break;
case 724:375===window.innerHeight?hideIOSFullscreenPanel():showIOSFullscreenPanel();break;default:hideIOSFullscreenPanel()}break;default:hideIOSFullscreenPanel()}}function iosResize(){__iosResize();setTimeout(function(){__iosResize()},500)}function iosInIframe(){try{return window.self!==window.top}catch(g){return!0}}$(document).ready(function(){platform&&"iPhone"===platform.product&&!iosInIframe()&&(buildIOSFullscreenPanel(),buildIOSMeta())});
jQuery(window).resize(function(){platform&&"iPhone"===platform.product&&!iosInIframe()&&iosResize()});
function CAreYouSurePanel(g){var h,f,e,c,a,b,d,m;this._init=function(k){b=new createjs.Shape;b.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);b.alpha=0;m=b.on("mousedown",function(){});s_oStage.addChild(b);(new createjs.Tween.get(b)).to({alpha:.7},500);d=new createjs.Container;s_oStage.addChild(d);k=s_oSpriteLibrary.getSprite("msg_box");var l=createBitmap(k);l.regX=k.width/2;l.regY=k.height/2;d.addChild(l);d.x=CANVAS_WIDTH/2;d.y=CANVAS_HEIGHT+k.height/2;h=d.y;(new createjs.Tween.get(d)).to({y:CANVAS_HEIGHT/
2-40},500,createjs.Ease.cubicOut);f=new createjs.Text(TEXT_ARE_SURE," 100px "+PRIMARY_FONT,"#000000");f.y=-k.height/2+120;f.textAlign="center";f.textBaseline="middle";f.lineWidth=600;f.outline=5;e=new createjs.Text(TEXT_ARE_SURE," 100px "+PRIMARY_FONT,"#ffffff");e.y=f.y;e.textAlign="center";e.textBaseline="middle";e.lineWidth=600;d.addChild(e);c=new CGfxButton(170,80,s_oSpriteLibrary.getSprite("but_yes"),d);c.addEventListener(ON_MOUSE_UP,this._onButYes,this);a=new CGfxButton(-170,80,s_oSpriteLibrary.getSprite("but_no"),
d);a.addEventListener(ON_MOUSE_UP,this._onButNo,this);a.pulseAnimation()};this._onButYes=function(){a.setClickable(!1);c.setClickable(!1);(new createjs.Tween.get(b)).to({alpha:0},500);(new createjs.Tween.get(d)).to({y:h},400,createjs.Ease.backIn).call(function(){k.unload();g()})};this._onButNo=function(){a.setClickable(!1);c.setClickable(!1);(new createjs.Tween.get(b)).to({alpha:0},500);(new createjs.Tween.get(d)).to({y:h},400,createjs.Ease.backIn).call(function(){k.unload()})};this.changeMessage=
function(a,b){f.text=a;e.text=a;b&&(f.font=" "+b+"px "+PRIMARY_FONT,e.font=" "+b+"px "+PRIMARY_FONT)};this.unload=function(){a.unload();c.unload();s_oStage.removeChild(b);s_oStage.removeChild(d);b.off("mousedown",m)};var k=this;this._init(g)}
!function(g){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=g();else if("function"==typeof define&&define.amd)define([],g);else{var h;"undefined"!=typeof window?h=window:"undefined"!=typeof global?h=global:"undefined"!=typeof self&&(h=self);h.TreeModel=g()}}(function(){return function c(h,f,e){function a(d,k){if(!f[d]){if(!h[d]){var m="function"==typeof require&&require;if(!k&&m)return m(d,!0);if(b)return b(d,!0);m=Error("Cannot find module '"+d+"'");throw m.code="MODULE_NOT_FOUND",
m;}m=f[d]={exports:{}};h[d][0].call(m.exports,function(b){var c=h[d][1][b];return a(c?c:b)},m,m.exports,c,h,f,e)}return f[d].exports}for(var b="function"==typeof require&&require,d=0;d<e.length;d++)a(e[d]);return a}({1:[function(h,f,e){var c=h("mergesort");var a=h("find-insert-index");f.exports=function(){function b(a){this.config=a=a||{};this.config.childrenPropertyName=a.childrenPropertyName||"children";this.config.modelComparatorFn=a.modelComparatorFn}function d(a,b){this.config=a;this.model=b;
this.children=[]}function m(b,c,m){if(!(c instanceof d))throw new TypeError("Child must be of type Node.");c.parent=b;b.model[b.config.childrenPropertyName]instanceof Array||(b.model[b.config.childrenPropertyName]=[]);if("function"===typeof b.config.modelComparatorFn){var k=a(b.config.modelComparatorFn,b.model[b.config.childrenPropertyName],c.model);b.model[b.config.childrenPropertyName].splice(k,0,c.model);b.children.splice(k,0,c)}else if(void 0===m)b.model[b.config.childrenPropertyName].push(c.model),
b.children.push(c);else{if(0>m||m>b.children.length)throw Error("Invalid index.");b.model[b.config.childrenPropertyName].splice(m,0,c.model);b.children.splice(k,0,c)}return c}function k(){var a={};1===arguments.length?a.fn=arguments[0]:2===arguments.length?"function"===typeof arguments[0]?(a.fn=arguments[0],a.ctx=arguments[1]):(a.options=arguments[0],a.fn=arguments[1]):(a.options=arguments[0],a.fn=arguments[1],a.ctx=arguments[2]);a.options=a.options||{};a.options.strategy||(a.options.strategy="pre");
if(!l[a.options.strategy])throw Error("Unknown tree walk strategy. Valid strategies are 'pre' [default], 'post' and 'breadth'.");return a}var l={};b.prototype.parse=function(a){var b;if(!(a instanceof Object))throw new TypeError("Model must be of type object.");var m=new d(this.config,a);if(a[this.config.childrenPropertyName]instanceof Array){this.config.modelComparatorFn&&(a[this.config.childrenPropertyName]=c(this.config.modelComparatorFn,a[this.config.childrenPropertyName]));var k=0;for(b=a[this.config.childrenPropertyName].length;k<
b;k++){var l=m,f=this.parse(a[this.config.childrenPropertyName][k]);f.parent=l;l.children.push(f)}}return m};d.prototype.isRoot=function(){return void 0===this.parent};d.prototype.hasChildren=function(){return 0<this.children.length};d.prototype.addChild=function(a){return m(this,a)};d.prototype.addChildAtIndex=function(a,b){if("function"===typeof this.config.modelComparatorFn)throw Error("Cannot add child at index when using a comparator function.");return m(this,a,b)};d.prototype.getPath=function(){var a=
[];(function v(b){a.unshift(b);b.isRoot()||v(b.parent)})(this);return a};d.prototype.walk=function(){var a=k.apply(this,arguments);l[a.options.strategy].call(this,a.fn,a.ctx)};l.pre=function v(a,b){var d;var c=a.call(b,this);var m=0;for(d=this.children.length;m<d;m++){if(!1===c)return!1;c=v.call(this.children[m],a,b)}return c};l.post=function r(a,b){var d;var c=0;for(d=this.children.length;c<d;c++){var m=r.call(this.children[c],a,b);if(!1===m)return!1}return m=a.call(b,this)};l.breadth=function(a,
b){var d=[this];(function A(){var c;if(0!==d.length){var m=d.shift();var k=0;for(c=m.children.length;k<c;k++)d.push(m.children[k]);!1!==a.call(b,m)&&A()}})()};d.prototype.all=function(){var a=[];var b=k.apply(this,arguments);l[b.options.strategy].call(this,function(d){b.fn.call(b.ctx,d)&&a.push(d)},b.ctx);return a};d.prototype.first=function(){var a;var b=k.apply(this,arguments);l[b.options.strategy].call(this,function(d){if(b.fn.call(b.ctx,d))return a=d,!1},b.ctx);return a};d.prototype.drop=function(){if(!this.isRoot()){var a=
this.parent.children.indexOf(this);this.parent.children.splice(a,1);this.parent.model[this.config.childrenPropertyName].splice(a,1);this.parent=void 0;delete this.parent}return this};return b}()},{"find-insert-index":2,mergesort:3}],2:[function(h,f,e){f.exports=function(){return function(c,a,b){var d;var m=0;for(d=a.length;m<d&&!(0<c(a[m],b));m++);return m}}()},{}],3:[function(h,f,e){f.exports=function(){function c(a,b){var d=b.length;if(2<=d){var m=b.slice(0,d/2);d=b.slice(d/2,d);m=c(a,m);d=c(a,
d);for(var k=[],l=m.length,f=d.length;0<l&&0<f;)0>=a(m[0],d[0])?(k.push(m.shift()),l--):(k.push(d.shift()),f--);0<l?k.push.apply(k,m):k.push.apply(k,d);return k}return b.slice()}return c}()},{}]},{},[1])(1)});
function CTreeDecision(g){var h,f,e;this._init=function(c){h=[];for(var a=0;a<SEARCH_DEPTH+1;a++)h[a]=[];f=new TreeModel;e=f.parse(c);h[0][0]=e};this.getRoot=function(){return e};this.initNewNode=function(c){h[c].push(f.parse({rating:0,moves:[],depth:c}));return h[c][h[c].length-1]};this.addNode=function(c,a,b){var d=c+1,m=h[d].length-1;h[d][m].model.moves=b;h[d][m].model.rating=a;h[c][h[c].length-1].addChild(h[d][m])};this.rateNode=function(c,a){c.model.rating=a};this.getNode=function(c,a){return e.all(function(b){return b.model.rating===
c&&b.model.depth===a})};this.getPath=function(c){return c.getPath()};this.getTerminalNodes=function(){return e.all(function(c){return!c.hasChildren()})};this._init(g)}var s_iScaleFactor=1,s_bIsIphone=!1,s_iOffsetX,s_iOffsetY;
(function(g){(jQuery.browser=jQuery.browser||{}).mobile=/android|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(ad|hone|od)|iris|kindle|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|symbian|tablet|treo|up\.(browser|link)|vodafone|wap|webos|windows (ce|phone)|xda|xiino/i.test(g)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|e\-|e\/|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(di|rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|xda(\-|2|g)|yas\-|your|zeto|zte\-/i.test(g.substr(0,
4))})(navigator.userAgent||navigator.vendor||window.opera);$(window).resize(function(){sizeHandler()});function trace(g){console.log(g)}
function getSize(g){var h=g.toLowerCase(),f=window.document,e=f.documentElement;if(void 0===window["inner"+g])g=e["client"+g];else if(window["inner"+g]!=e["client"+g]){var c=f.createElement("body");c.id="vpw-test-b";c.style.cssText="overflow:scroll";var a=f.createElement("div");a.id="vpw-test-d";a.style.cssText="position:absolute;top:-1000px";a.innerHTML="<style>@media("+h+":"+e["client"+g]+"px){body#vpw-test-b div#vpw-test-d{"+h+":7px!important}}</style>";c.appendChild(a);e.insertBefore(c,f.head);
g=7==a["offset"+g]?e["client"+g]:window["inner"+g];e.removeChild(c)}else g=window["inner"+g];return g}window.addEventListener("orientationchange",onOrientationChange);function onOrientationChange(){window.matchMedia("(orientation: portrait)").matches&&sizeHandler();window.matchMedia("(orientation: landscape)").matches&&sizeHandler()}function isChrome(){return/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)}
function isIOS(){var g="iPad Simulator;iPhone Simulator;iPod Simulator;iPad;iPhone;iPod".split(";");for(-1!==navigator.userAgent.toLowerCase().indexOf("iphone")&&(s_bIsIphone=!0);g.length;)if(navigator.platform===g.pop())return!0;return s_bIsIphone=!1}function getIOSWindowHeight(){return document.documentElement.clientWidth/window.innerWidth*window.innerHeight}function getHeightOfIOSToolbars(){var g=(0===window.orientation?screen.height:screen.width)-getIOSWindowHeight();return 1<g?g:0}
function playSound(g,h,f){return!1===DISABLE_SOUND_MOBILE||!1===s_bMobile?(s_aSounds[g].play(),s_aSounds[g].volume(h),s_aSounds[g].loop(f),s_aSounds[g]):null}function stopSound(g){!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||s_aSounds[g].stop()}function setVolume(g,h){!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||s_aSounds[g].volume(h)}function setMute(g,h){!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||s_aSounds[g].mute(h)}
function sizeHandler(){window.scrollTo(0,1);if($("#canvas")){var g=navigator.userAgent.match(/(iPad|iPhone|iPod)/g)?getIOSWindowHeight():getSize("Height");var h=getSize("Width");_checkOrientation(h,g);var f=Math.min(g/CANVAS_HEIGHT,h/CANVAS_WIDTH),e=CANVAS_WIDTH*f;f*=CANVAS_HEIGHT;if(f<g){var c=g-f;f+=c;e+=CANVAS_WIDTH/CANVAS_HEIGHT*c}else e<h&&(c=h-e,e+=c,f+=CANVAS_HEIGHT/CANVAS_WIDTH*c);c=g/2-f/2;var a=h/2-e/2,b=CANVAS_WIDTH/e;if(a*b<-EDGEBOARD_X||c*b<-EDGEBOARD_Y)f=Math.min(g/(CANVAS_HEIGHT-2*
EDGEBOARD_Y),h/(CANVAS_WIDTH-2*EDGEBOARD_X)),e=CANVAS_WIDTH*f,f*=CANVAS_HEIGHT,c=(g-f)/2,a=(h-e)/2,b=CANVAS_WIDTH/e;s_iOffsetX=-1*a*b;s_iOffsetY=-1*c*b;0<=c&&(s_iOffsetY=0);0<=a&&(s_iOffsetX=0);null!==s_oInterface&&s_oInterface.refreshButtonPos(s_iOffsetX,s_iOffsetY);null!==s_oMenu&&s_oMenu.refreshButtonPos(s_iOffsetX,s_iOffsetY);null!==s_oModeMenu&&s_oModeMenu.refreshButtonPos(s_iOffsetX,s_iOffsetY);s_bIsIphone?(canvas=document.getElementById("canvas"),s_oStage.canvas.width=2*e,s_oStage.canvas.height=
2*f,canvas.style.width=e+"px",canvas.style.height=f+"px",s_oStage.scaleX=s_oStage.scaleY=2*Math.min(e/CANVAS_WIDTH,f/CANVAS_HEIGHT)):s_bMobile||isChrome()?($("#canvas").css("width",e+"px"),$("#canvas").css("height",f+"px")):(s_oStage.canvas.width=e,s_oStage.canvas.height=f,s_iScaleFactor=Math.min(e/CANVAS_WIDTH,f/CANVAS_HEIGHT),s_oStage.scaleX=s_oStage.scaleY=s_iScaleFactor);0>c?$("#canvas").css("top",c+"px"):$("#canvas").css("top","0px");$("#canvas").css("left",a+"px");fullscreenHandler()}}
function _checkOrientation(g,h){s_bMobile&&ENABLE_CHECK_ORIENTATION&&(g>h?"landscape"===$(".orientation-msg-container").attr("data-orientation")?($(".orientation-msg-container").css("display","none"),s_oMain.startUpdate()):($(".orientation-msg-container").css("display","block"),s_oMain.stopUpdate()):"portrait"===$(".orientation-msg-container").attr("data-orientation")?($(".orientation-msg-container").css("display","none"),s_oMain.startUpdate()):($(".orientation-msg-container").css("display","block"),
s_oMain.stopUpdate()))}function createBitmap(g,h,f){var e=new createjs.Bitmap(g),c=new createjs.Shape;h&&f?c.graphics.beginFill("#fff").drawRect(0,0,h,f):c.graphics.beginFill("#ff0").drawRect(0,0,g.width,g.height);e.hitArea=c;return e}function createSprite(g,h,f,e,c,a){g=null!==h?new createjs.Sprite(g,h):new createjs.Sprite(g);h=new createjs.Shape;h.graphics.beginFill("#000000").drawRect(-f,-e,c,a);g.hitArea=h;return g}
function pad(g,h,f){g+="";return g.length>=h?g:Array(h-g.length+1).join(f||"0")+g}function randomFloatBetween(g,h,f){"undefined"===typeof f&&(f=2);return parseFloat(Math.min(g+Math.random()*(h-g),h).toFixed(f))}function rotateVector2D(g,h){var f=h.getX()*Math.cos(g)+h.getY()*Math.sin(g),e=h.getX()*-Math.sin(g)+h.getY()*Math.cos(g);h.set(f,e)}function tweenVectorsOnX(g,h,f){return g+f*(h-g)}
function shuffle(g){for(var h=g.length,f,e;0!==h;)e=Math.floor(Math.random()*h),--h,f=g[h],g[h]=g[e],g[e]=f;return g}function bubbleSort(g){do{var h=!1;for(var f=0;f<g.length-1;f++)g[f]>g[f+1]&&(h=g[f],g[f]=g[f+1],g[f+1]=h,h=!0)}while(h)}function compare(g,h){return g.index>h.index?-1:g.index<h.index?1:0}function easeLinear(g,h,f,e){return f*g/e+h}function easeInQuad(g,h,f,e){return f*(g/=e)*g+h}function easeInSine(g,h,f,e){return-f*Math.cos(g/e*(Math.PI/2))+f+h}
function easeInCubic(g,h,f,e){return f*(g/=e)*g*g+h}function getTrajectoryPoint(g,h){var f=new createjs.Point,e=(1-g)*(1-g),c=g*g;f.x=e*h.start.x+2*(1-g)*g*h.traj.x+c*h.end.x;f.y=e*h.start.y+2*(1-g)*g*h.traj.y+c*h.end.y;return f}function formatTime(g){g/=1E3;var h=Math.floor(g/60);g=Math.floor(g-60*h);var f="";f=10>h?f+("0"+h+":"):f+(h+":");return 10>g?f+("0"+g):f+g}function degreesToRadians(g){return g*Math.PI/180}
function checkRectCollision(g,h){var f=getBounds(g,.9);var e=getBounds(h,.98);return calculateIntersection(f,e)}function calculateIntersection(g,h){var f,e,c,a;var b=g.x+(f=g.width/2);var d=g.y+(e=g.height/2);var m=h.x+(c=h.width/2);var k=h.y+(a=h.height/2);b=Math.abs(b-m)-(f+c);d=Math.abs(d-k)-(e+a);return 0>b&&0>d?(b=Math.min(Math.min(g.width,h.width),-b),d=Math.min(Math.min(g.height,h.height),-d),{x:Math.max(g.x,h.x),y:Math.max(g.y,h.y),width:b,height:d,rect1:g,rect2:h}):null}
function getBounds(g,h){var f={x:Infinity,y:Infinity,width:0,height:0};if(g instanceof createjs.Container){f.x2=-Infinity;f.y2=-Infinity;var e=g.children,c=e.length,a;for(a=0;a<c;a++){var b=getBounds(e[a],1);b.x<f.x&&(f.x=b.x);b.y<f.y&&(f.y=b.y);b.x+b.width>f.x2&&(f.x2=b.x+b.width);b.y+b.height>f.y2&&(f.y2=b.y+b.height)}Infinity==f.x&&(f.x=0);Infinity==f.y&&(f.y=0);Infinity==f.x2&&(f.x2=0);Infinity==f.y2&&(f.y2=0);f.width=f.x2-f.x;f.height=f.y2-f.y;delete f.x2;delete f.y2}else{if(g instanceof createjs.Bitmap){c=
g.sourceRect||g.image;a=c.width*h;var d=c.height*h}else if(g instanceof createjs.Sprite)if(g.spriteSheet._frames&&g.spriteSheet._frames[g.currentFrame]&&g.spriteSheet._frames[g.currentFrame].image){c=g.spriteSheet.getFrame(g.currentFrame);a=c.rect.width;d=c.rect.height;e=c.regX;var m=c.regY}else f.x=g.x||0,f.y=g.y||0;else f.x=g.x||0,f.y=g.y||0;e=e||0;a=a||0;m=m||0;d=d||0;f.regX=e;f.regY=m;c=g.localToGlobal(0-e,0-m);b=g.localToGlobal(a-e,d-m);a=g.localToGlobal(a-e,0-m);e=g.localToGlobal(0-e,d-m);f.x=
Math.min(Math.min(Math.min(c.x,b.x),a.x),e.x);f.y=Math.min(Math.min(Math.min(c.y,b.y),a.y),e.y);f.width=Math.max(Math.max(Math.max(c.x,b.x),a.x),e.x)-f.x;f.height=Math.max(Math.max(Math.max(c.y,b.y),a.y),e.y)-f.y}return f}function NoClickDelay(g){this.element=g;window.Touch&&this.element.addEventListener("touchstart",this,!1)}function shuffle(g){for(var h=g.length,f,e;0<h;)e=Math.floor(Math.random()*h),h--,f=g[h],g[h]=g[e],g[e]=f;return g}
NoClickDelay.prototype={handleEvent:function(g){switch(g.type){case "touchstart":this.onTouchStart(g);break;case "touchmove":this.onTouchMove(g);break;case "touchend":this.onTouchEnd(g)}},onTouchStart:function(g){g.preventDefault();this.moved=!1;this.element.addEventListener("touchmove",this,!1);this.element.addEventListener("touchend",this,!1)},onTouchMove:function(g){this.moved=!0},onTouchEnd:function(g){this.element.removeEventListener("touchmove",this,!1);this.element.removeEventListener("touchend",
this,!1);if(!this.moved){g=document.elementFromPoint(g.changedTouches[0].clientX,g.changedTouches[0].clientY);3==g.nodeType&&(g=g.parentNode);var h=document.createEvent("MouseEvents");h.initEvent("click",!0,!0);g.dispatchEvent(h)}}};
(function(){function g(f){var e={focus:"visible",focusin:"visible",pageshow:"visible",blur:"hidden",focusout:"hidden",pagehide:"hidden"};f=f||window.event;f.type in e?document.body.className=e[f.type]:(document.body.className=this[h]?"hidden":"visible","hidden"===document.body.className?s_oMain.stopUpdate():s_oMain.startUpdate())}var h="hidden";h in document?document.addEventListener("visibilitychange",g):(h="mozHidden")in document?document.addEventListener("mozvisibilitychange",g):(h="webkitHidden")in
document?document.addEventListener("webkitvisibilitychange",g):(h="msHidden")in document?document.addEventListener("msvisibilitychange",g):"onfocusin"in document?document.onfocusin=document.onfocusout=g:window.onpageshow=window.onpagehide=window.onfocus=window.onblur=g})();function compareRow(g,h){return g.row>h.row?1:g.row<h.row?-1:0}function compareCol(g,h){return g.col>h.col?1:g.col<h.col?-1:0}function ctlArcadeResume(){null!==s_oMain&&s_oMain.startUpdate()}
function ctlArcadePause(){null!==s_oMain&&s_oMain.stopUpdate()}function getParamValue(g){for(var h=window.location.search.substring(1).split("&"),f=0;f<h.length;f++){var e=h[f].split("=");if(e[0]==g)return e[1]}}String.prototype.format=function(){for(var g=this,h=arguments.length;h--;)g=g.replace(new RegExp("\\{"+h+"\\}","gm"),arguments[h]);return g};
function fullscreenHandler(){ENABLE_FULLSCREEN&&!1!==screenfull.enabled&&(s_bFullscreen=screen.height<window.innerHeight+3&&screen.height>window.innerHeight-3?!0:!1,null!==s_oInterface&&s_oInterface.resetFullscreenBut(),null!==s_oMenu&&s_oMenu.resetFullscreenBut(),null!==s_oModeMenu&&s_oModeMenu.resetFullscreenBut())}
if(screenfull.enabled)screenfull.on("change",function(){s_bFullscreen=screenfull.isFullscreen;null!==s_oInterface&&s_oInterface.resetFullscreenBut();null!==s_oMenu&&s_oMenu.resetFullscreenBut();null!==s_oModeMenu&&s_oModeMenu.resetFullscreenBut()});
function CSpriteLibrary(){var g,h,f,e,c,a;this.init=function(b,d,m){f=h=0;e=b;c=d;a=m;g={}};this.addSprite=function(a,d){g.hasOwnProperty(a)||(g[a]={szPath:d,oSprite:new Image},h++)};this.getSprite=function(a){return g.hasOwnProperty(a)?g[a].oSprite:null};this._onSpritesLoaded=function(){c.call(a)};this._onSpriteLoaded=function(){e.call(a);++f==h&&this._onSpritesLoaded()};this.loadSprites=function(){for(var a in g)g[a].oSprite.oSpriteLibrary=this,g[a].oSprite.onload=function(){this.oSpriteLibrary._onSpriteLoaded()},
g[a].oSprite.src=g[a].szPath};this.getNumSprites=function(){return h}}
var CANVAS_WIDTH=1280,CANVAS_HEIGHT=1920,EDGEBOARD_X=150,EDGEBOARD_Y=280,FPS_TIME=1E3/24,DISABLE_SOUND_MOBILE=!1,PRIMARY_FONT="arialrounded",STATE_LOADING=0,STATE_MENU=1,STATE_HELP=1,STATE_GAME=3,ON_MOUSE_DOWN=0,ON_MOUSE_UP=1,ON_MOUSE_OVER=2,ON_MOUSE_OUT=3,ON_DRAG_START=4,ON_DRAG_END=5,MODE_HUMAN=0,MODE_COMPUTER=1,EASY_MODE=0,MEDIUM_MODE=1,HARD_MODE=2,WHITE="white",BLACK="black",PAWN="pawn",ROOK="rook",KNIGHT="knight",BISHOP="bishop",QUEEN="queen",KING="king",PLAYER_STATE_WAIT=0,PLAYER_STATE_SELECTED=
1,PLAYER_STATE_MOVING=2,BOARD_STATE_STALEMATE=0,BOARD_STATE_CHECK=1,BOARD_STATE_PROMOTION=2,BOARD_STATE_CHECKMATE=3,BOARD_SPECIAL_CASTLING_RIGHT=0,BOARD_SPECIAL_CASTLING_LEFT=1,BOARD_SPECIAL_ENPASSANT=2,NUM_CELL=8,BOARD_LENGTH=815,CELL_LENGTH=BOARD_LENGTH/NUM_CELL,DRAW=-1,TIME_MOVE=1E3,TIME_LOOP_WAIT=1E3,MIN_AI_THINKING=1E3,MAX_AI_THINKING=1500,INFINITE=99999,SEARCH_DEPTH,DRAW_COUNTER=50,START_SCORE,SCORE_DECREASE_PER_SECOND,SHOW_SCORE,ENABLE_CHECK_ORIENTATION,ENABLE_FULLSCREEN,TEXT_PRELOADER_CONTINUE=
"START",TEXT_DRAW="DRAW",TEXT_WINS="({0} wins)",TEXT_CHECKMATE="CHECKMATE!",TEXT_STALEMATE="STALEMATE!",TEXT_THINKING="THINKING",TEXT_ARE_SURE="ARE YOU SURE?",TEXT_MODE="CHOOSE GAME MODE",TEXT_BLACK="BLACK",TEXT_WHITE="WHITE",TEXT_PROMOTION="SELECT THE PIECE YOU WANT TO PROMOTE YOUR PAWN INTO",TEXT_CHECK="CHECK!",TEXT_CREDITS_DEVELOPED="",TEXT_SHARE_IMAGE="200x200.jpg",TEXT_SHARE_TITLE="Congratulations!",TEXT_SHARE_MSG1="You collected <strong>",TEXT_SHARE_MSG2=" points</strong>!<br><br>Share your score with your friends!",
TEXT_SHARE_SHARE1="My score is ",TEXT_SHARE_SHARE2=" points! Can you do better?";
function CPreloader(){var g,h,f,e,c,a,b,d,m,k;this._init=function(){s_oSpriteLibrary.init(this._onImagesLoaded,this._onAllImagesLoaded,this);s_oSpriteLibrary.addSprite("progress_bar","./sprites/progress_bar.png");s_oSpriteLibrary.addSprite("200x200","./sprites/200x200.jpg");s_oSpriteLibrary.addSprite("but_start","./sprites/but_start.png");s_oSpriteLibrary.loadSprites();k=new createjs.Container;s_oStage.addChild(k)};this.unload=function(){k.removeAllChildren();m.unload()};this._onImagesLoaded=function(){};
this._onAllImagesLoaded=function(){this.attachSprites();s_oMain.preloaderReady()};this.attachSprites=function(){var l=new createjs.Shape;l.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);k.addChild(l);l=s_oSpriteLibrary.getSprite("200x200");b=createBitmap(l);b.regX=.5*l.width;b.regY=.5*l.height;b.x=CANVAS_WIDTH/2;b.y=CANVAS_HEIGHT/2-180;k.addChild(b);d=new createjs.Shape;d.graphics.beginFill("rgba(0,0,0,0.01)").drawRoundRect(b.x-100,b.y-100,200,200,10);k.addChild(d);b.mask=d;
l=s_oSpriteLibrary.getSprite("progress_bar");e=createBitmap(l);e.x=CANVAS_WIDTH/2-l.width/2;e.y=CANVAS_HEIGHT/2+50;k.addChild(e);g=l.width;h=l.height;c=new createjs.Shape;c.graphics.beginFill("rgba(0,0,0,0.01)").drawRect(e.x,e.y,1,h);k.addChild(c);e.mask=c;f=new createjs.Text("","30px "+PRIMARY_FONT,"#fff");f.x=CANVAS_WIDTH/2;f.y=CANVAS_HEIGHT/2+100;f.textBaseline="alphabetic";f.textAlign="center";k.addChild(f);l=s_oSpriteLibrary.getSprite("but_start");m=new CTextButton(CANVAS_WIDTH/2,CANVAS_HEIGHT/
2,l,TEXT_PRELOADER_CONTINUE,"Arial","#000",40,k);m.addEventListener(ON_MOUSE_UP,this._onButStartRelease,this);m.setVisible(!1);a=new createjs.Shape;a.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);k.addChild(a);createjs.Tween.get(a).to({alpha:0},500).call(function(){createjs.Tween.removeTweens(a);k.removeChild(a)})};this._onButStartRelease=function(){$(s_oMain).trigger("show_preroll_ad");s_oMain._onPreloaderComplete()};this.refreshLoader=function(a){f.text=a+"%";100===a&&(m.setVisible(!0),
f.visible=!1,e.visible=!1);c.graphics.clear();a=Math.floor(a*g/100);c.graphics.beginFill("rgba(0,0,0,0.01)").drawRect(e.x,e.y,a,h)};this._init()}
function CCreditsPanel(){var g,h,f,e,c,a,b,d,m;this._init=function(){c=new createjs.Shape;c.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);c.alpha=0;s_oStage.addChild(c);(new createjs.Tween.get(c)).to({alpha:.7},500);var k=s_oSpriteLibrary.getSprite("msg_box");m=new createjs.Container;m.y=CANVAS_HEIGHT+k.height/2;s_oStage.addChild(m);g=createBitmap(k);g.regX=k.width/2;g.regY=k.height/2;g.x=CANVAS_WIDTH/2;g.y=CANVAS_HEIGHT/2;m.addChild(g);b=new createjs.Shape;b.graphics.beginFill("#0f0f0f").drawRect(0,
0,CANVAS_WIDTH,CANVAS_HEIGHT);b.alpha=.01;a=b.on("click",this._onLogoButRelease);m.addChild(b);k=s_oSpriteLibrary.getSprite("but_exit");f=new CGfxButton(1E3,610,k,m);f.addEventListener(ON_MOUSE_UP,this.unload,this);e=new createjs.Text(TEXT_CREDITS_DEVELOPED,"80px "+PRIMARY_FONT,"#402604");e.textAlign="center";e.textBaseline="alphabetic";e.x=CANVAS_WIDTH/2;e.y=CANVAS_HEIGHT/2-100;m.addChild(e);k=s_oSpriteLibrary.getSprite("logo_ctl");h=createBitmap(k);h.regX=k.width/2;h.regY=k.height/2;h.x=CANVAS_WIDTH/
2;h.y=CANVAS_HEIGHT/2;m.addChild(h);d=new createjs.Text("","68px "+PRIMARY_FONT,"#402604");d.textAlign="center";d.textBaseline="alphabetic";d.x=CANVAS_WIDTH/2;d.y=CANVAS_HEIGHT/2+130;m.addChild(d);(new createjs.Tween.get(m)).to({y:0},1E3,createjs.Ease.backOut)};this.unload=function(){b.off("click",a);f.unload();f=null;s_oStage.removeChild(c);s_oStage.removeChild(m)};this._onLogoButRelease=function(){window.open("https://www.google.com/","")};this._init()}
function CMain(g){var h,f=0,e=0,c=STATE_LOADING,a,b;this.initContainer=function(){s_oCanvas=document.getElementById("canvas");s_oStage=new createjs.Stage(s_oCanvas);createjs.Touch.enable(s_oStage);s_bMobile=jQuery.browser.mobile;!1===s_bMobile&&(s_oStage.enableMouseOver(20),$("body").on("contextmenu","#canvas",function(a){return!1}));s_iPrevTime=(new Date).getTime();createjs.Ticker.addEventListener("tick",this._update);createjs.Ticker.framerate=30;navigator.userAgent.match(/Windows Phone/i)&&(DISABLE_SOUND_MOBILE=
!0);s_oSpriteLibrary=new CSpriteLibrary;a=new CPreloader};this.preloaderReady=function(){this._loadImages();!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||this._initSounds();h=!0};this.soundLoaded=function(){f++;a.refreshLoader(Math.floor(f/e*100))};this._initSounds=function(){var a=[];a.push({path:"./sounds/",filename:"game_over",loop:!1,volume:1,ingamename:"game_over"});a.push({path:"./sounds/",filename:"click",loop:!1,volume:1,ingamename:"click"});a.push({path:"./sounds/",filename:"win",loop:!1,volume:1,
ingamename:"win"});e+=a.length;s_aSounds=[];for(var b=0;b<a.length;b++)s_aSounds[a[b].ingamename]=new Howl({src:[a[b].path+a[b].filename+".mp3",a[b].path+a[b].filename+".ogg"],autoplay:!1,preload:!0,loop:a[b].loop,volume:a[b].volume,onload:s_oMain.soundLoaded})};this._loadImages=function(){s_oSpriteLibrary.init(this._onImagesLoaded,this._onAllImagesLoaded,this);s_oSpriteLibrary.addSprite("but_play","./sprites/but_play.png");s_oSpriteLibrary.addSprite("msg_box","./sprites/msg_box.png");s_oSpriteLibrary.addSprite("bg_menu",
"./sprites/bg_menu.jpg");s_oSpriteLibrary.addSprite("bg_mod_menu","./sprites/bg_mod_menu.jpg");s_oSpriteLibrary.addSprite("bg_game","./sprites/bg_game.jpg");s_oSpriteLibrary.addSprite("but_credits","./sprites/but_credits.png");s_oSpriteLibrary.addSprite("but_fullscreen","./sprites/but_fullscreen.png");s_oSpriteLibrary.addSprite("logo_ctl","./sprites/200x200.jpg");s_oSpriteLibrary.addSprite("but_vs_man","./sprites/vs_man_panel.png");s_oSpriteLibrary.addSprite("but_vs_pc","./sprites/vs_pc_panel.png");
s_oSpriteLibrary.addSprite("message","./sprites/message.png");s_oSpriteLibrary.addSprite("but_home","./sprites/but_home.png");s_oSpriteLibrary.addSprite("but_show","./sprites/but_show.png");s_oSpriteLibrary.addSprite("but_exit","./sprites/but_exit.png");s_oSpriteLibrary.addSprite("audio_icon","./sprites/audio_icon.png");s_oSpriteLibrary.addSprite("but_settings","./sprites/but_settings.png");s_oSpriteLibrary.addSprite("board8","./sprites/grid_8.png");s_oSpriteLibrary.addSprite("threat","./sprites/threat.png");
s_oSpriteLibrary.addSprite("highlight","./sprites/highlight.png");s_oSpriteLibrary.addSprite("bg_turn","./sprites/player_panel.png");s_oSpriteLibrary.addSprite("audio_icon_big","./sprites/audio_icon_big.png");s_oSpriteLibrary.addSprite("black_bishop","./sprites/pieces/black_bishop.png");s_oSpriteLibrary.addSprite("black_king","./sprites/pieces/black_king.png");s_oSpriteLibrary.addSprite("black_knight","./sprites/pieces/black_knight.png");s_oSpriteLibrary.addSprite("black_pawn","./sprites/pieces/black_pawn.png");
s_oSpriteLibrary.addSprite("black_queen","./sprites/pieces/black_queen.png");s_oSpriteLibrary.addSprite("black_rook","./sprites/pieces/black_rook.png");s_oSpriteLibrary.addSprite("white_bishop","./sprites/pieces/white_bishop.png");s_oSpriteLibrary.addSprite("white_king","./sprites/pieces/white_king.png");s_oSpriteLibrary.addSprite("white_knight","./sprites/pieces/white_knight.png");s_oSpriteLibrary.addSprite("white_pawn","./sprites/pieces/white_pawn.png");s_oSpriteLibrary.addSprite("white_queen",
"./sprites/pieces/white_queen.png");s_oSpriteLibrary.addSprite("white_rook","./sprites/pieces/white_rook.png");s_oSpriteLibrary.addSprite("white_king_marker","./sprites/white_king_marker.png");s_oSpriteLibrary.addSprite("black_king_marker","./sprites/black_king_marker.png");s_oSpriteLibrary.addSprite("score_panel","./sprites/score_panel.png");s_oSpriteLibrary.addSprite("toggle_easy","./sprites/toggle_easy.png");s_oSpriteLibrary.addSprite("toggle_medium","./sprites/toggle_medium.png");s_oSpriteLibrary.addSprite("toggle_hard",
"./sprites/toggle_hard.png");s_oSpriteLibrary.addSprite("but_yes","./sprites/but_yes.png");s_oSpriteLibrary.addSprite("but_no","./sprites/but_no.png");s_oSpriteLibrary.addSprite("but_restart","./sprites/but_restart.png");e+=s_oSpriteLibrary.getNumSprites();s_oSpriteLibrary.loadSprites()};this._onImagesLoaded=function(){f++;a.refreshLoader(Math.floor(f/e*100))};this._onPreloaderComplete=function(){a.unload();this.gotoMenu()};this._onAllImagesLoaded=function(){};this.gotoMenu=function(){new CMenu;c=
STATE_MENU};this.gotoModeMenu=function(){new CModeMenu;c=STATE_MENU};this.gotoGame=function(a){s_iGameType=a;b=new CGame(d);c=STATE_GAME};this.gotoHelp=function(){new CHelp;c=STATE_HELP};this.stopUpdate=function(){h=!1;createjs.Ticker.paused=!0;$("#block_game").css("display","block");!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||Howler.mute(!0)};this.startUpdate=function(){s_iPrevTime=(new Date).getTime();h=!0;createjs.Ticker.paused=!1;$("#block_game").css("display","none");(!1===DISABLE_SOUND_MOBILE||
!1===s_bMobile)&&s_bAudioActive&&Howler.mute(!1)};this._update=function(a){if(!1!==h){var d=(new Date).getTime();s_iTimeElaps=d-s_iPrevTime;s_iCntTime+=s_iTimeElaps;s_iCntFps++;s_iPrevTime=d;1E3<=s_iCntTime&&(s_iCurFps=s_iCntFps,s_iCntTime-=1E3,s_iCntFps=0);c===STATE_GAME&&b.update();s_oStage.update(a)}};s_oMain=this;var d=g;ENABLE_CHECK_ORIENTATION=g.check_orientation;ENABLE_FULLSCREEN=g.fullscreen;this.initContainer()}
var s_bMobile,s_bAudioActive=!0,s_bFullscreen=!1,s_iCntTime=0,s_iTimeElaps=0,s_iPrevTime=0,s_iCntFps=0,s_iCurFps=0,s_oStage,s_oMain,s_oSpriteLibrary,s_oCanvas,s_iGameType,s_aSounds,s_bWeightSquares=!1,s_bEdgeSensitive=!1;
function CTextButton(g,h,f,e,c,a,b,d){var m,k,l,p,q,w,v;this._init=function(a,b,d,c,f,e,g,h){m=[];k=[];var r=createBitmap(d),v=Math.ceil(g/20);q=new createjs.Text(c,"bold "+g+"px "+f,"#000000");q.textAlign="center";q.textBaseline="alphabetic";var w=q.getBounds();q.x=d.width/2+v;q.y=Math.floor(d.height/2)+w.height/3+v;p=new createjs.Text(c,"bold "+g+"px "+f,e);p.textAlign="center";p.textBaseline="alphabetic";w=p.getBounds();p.x=d.width/2;p.y=Math.floor(d.height/2)+w.height/3;l=new createjs.Container;
l.x=a;l.y=b;l.regX=d.width/2;l.regY=d.height/2;l.addChild(r,q,p);h.addChild(l);this._initListener()};this.unload=function(){l.off("mousedown",w);l.off("pressup",v);d.removeChild(l)};this.setVisible=function(a){l.visible=a};this._initListener=function(){oParent=this;w=l.on("mousedown",this.buttonDown);v=l.on("pressup",this.buttonRelease)};this.addEventListener=function(a,b,d){m[a]=b;k[a]=d};this.buttonRelease=function(){l.scaleX=1;l.scaleY=1;m[ON_MOUSE_UP]&&m[ON_MOUSE_UP].call(k[ON_MOUSE_UP])};this.buttonDown=
function(){l.scaleX=.9;l.scaleY=.9;m[ON_MOUSE_DOWN]&&m[ON_MOUSE_DOWN].call(k[ON_MOUSE_DOWN])};this.setTextPosition=function(a){p.y=a;q.y=a+2};this.setPosition=function(a,b){l.x=a;l.y=b};this.setX=function(a){l.x=a};this.setY=function(a){l.y=a};this.getButtonImage=function(){return l};this.getX=function(){return l.x};this.getY=function(){return l.y};this._init(g,h,f,e,c,a,b,d);return this}
function CToggle(g,h,f,e,c){var a,b,d,m,k=[],l,p,q,w;this._init=function(k,f,e,g){b=!1;d=[];m=[];var h=new createjs.SpriteSheet({images:[e],frames:{width:e.width/2,height:e.height,regX:e.width/2/2,regY:e.height/2},animations:{state_true:[0],state_false:[1]}});a=g;l=createSprite(h,"state_"+a,e.width/2/2,e.height/2,e.width/2,e.height);l.x=k;l.y=f;l.stop();c.addChild(l);this._initListener()};this.unload=function(){s_bMobile?l.off("mousedown",p):(l.off("mousedown",p),l.off("mouseover",q));l.off("pressup",
w);c.removeChild(l)};this._initListener=function(){s_bMobile?p=l.on("mousedown",this.buttonDown):(p=l.on("mousedown",this.buttonDown),q=l.on("mouseover",this.buttonOver));w=l.on("pressup",this.buttonRelease)};this.addEventListener=function(a,b,c){d[a]=b;m[a]=c};this.addEventListenerWithParams=function(a,b,c,l){d[a]=b;m[a]=c;k=l};this.setActive=function(b){a=b;l.gotoAndStop("state_"+a)};this.buttonRelease=function(){l.scaleX=1;l.scaleY=1;playSound("click",1,!1);a=!a;l.gotoAndStop("state_"+a);d[ON_MOUSE_UP]&&
d[ON_MOUSE_UP].call(m[ON_MOUSE_UP],k)};this.buttonDown=function(){l.scaleX=.9;l.scaleY=.9;d[ON_MOUSE_DOWN]&&d[ON_MOUSE_DOWN].call(m[ON_MOUSE_DOWN],k)};this.buttonOver=function(a){s_bMobile||b||(a.target.cursor="pointer")};this.setPosition=function(a,b){l.x=a;l.y=b};this.setVisible=function(a){l.visible=a};this._init(g,h,f,e)}
function CGfxButton(g,h,f,e){var c,a,b,d,m,k,l,p;this._init=function(k,l,f,e){c=!1;a=1;b=[];d=[];m=createBitmap(f);m.x=k;m.y=l;m.scaleX=m.scaleY=a;m.regX=f.width/2;m.regY=f.height/2;e.addChild(m);this._initListener()};this.unload=function(){s_bMobile?m.off("mousedown",k):(m.off("mousedown",k),m.off("mouseover",l));m.off("pressup",p);e.removeChild(m)};this.setVisible=function(a){m.visible=a};this.setClickable=function(a){c=!a};this._initListener=function(){s_bMobile?k=m.on("mousedown",this.buttonDown):
(k=m.on("mousedown",this.buttonDown),l=m.on("mouseover",this.buttonOver));p=m.on("pressup",this.buttonRelease)};this.addEventListener=function(a,c,m){b[a]=c;d[a]=m};this.buttonRelease=function(){c||(m.scaleX=a,m.scaleY=a,b[ON_MOUSE_UP]&&b[ON_MOUSE_UP].call(d[ON_MOUSE_UP]))};this.buttonDown=function(){c||(m.scaleX=.9*a,m.scaleY=.9*a,playSound("click",1,!1),b[ON_MOUSE_DOWN]&&b[ON_MOUSE_DOWN].call(d[ON_MOUSE_DOWN]))};this.buttonOver=function(a){s_bMobile||c||(a.target.cursor="pointer")};this.pulseAnimation=
function(){createjs.Tween.get(m).to({scaleX:.9*a,scaleY:.9*a},850,createjs.Ease.quadOut).to({scaleX:a,scaleY:a},650,createjs.Ease.quadIn).call(function(){q.pulseAnimation()})};this.trembleAnimation=function(){createjs.Tween.get(m).to({rotation:5},75,createjs.Ease.quadOut).to({rotation:-5},140,createjs.Ease.quadIn).to({rotation:0},75,createjs.Ease.quadIn).wait(750).call(function(){q.trebleAnimation()})};this.setPosition=function(a,b){m.x=a;m.y=b};this.setX=function(a){m.x=a};this.setY=function(a){m.y=
a};this.getButtonImage=function(){return m};this.getX=function(){return m.x};this.getY=function(){return m.y};var q=this;this._init(g,h,f,e);return this}
function CMessage(g,h){var f,e,c,a;this._init=function(b,m){b===WHITE?(f=306,e=-200,c=1580):(f=976,e=CANVAS_HEIGHT+200,c=338);a=new createjs.Container;a.x=f;a.y=e;s_bMobile&&b===BLACK&&s_iGameType===MODE_HUMAN&&(a.rotation=180);s_oStage.addChild(a);var d=s_oSpriteLibrary.getSprite("message"),l=createBitmap(d);l.regX=d.width/2;l.regY=d.height/2;d=new createjs.Text(m," 40px "+PRIMARY_FONT,"#ffffff");d.textAlign="center";d.textBaseline="top";d.lineWidth=350;d.regY=d.getBounds().height/2;a.addChild(l,
d);createjs.Tween.get(a).to({y:c},750,createjs.Ease.cubicOut)};this.unload=function(){s_oStage.removeChild(a)};this.removeAnimated=function(){a.x>CANVAS_WIDTH/2?createjs.Tween.get(a).to({x:CANVAS_WIDTH+200},500,createjs.Ease.cubicOut).call(function(){b.unload()}):createjs.Tween.get(a).to({x:-200},500,createjs.Ease.cubicOut).call(function(){b.unload()})};var b=this;this._init(g,h)}
function CMenu(){var g,h,f,e,c,a,b,d,m,k,l,p,q=null,w=null;this._init=function(){b=createBitmap(s_oSpriteLibrary.getSprite("bg_menu"));s_oStage.addChild(b);var v=s_oSpriteLibrary.getSprite("but_play");d=new CGfxButton(CANVAS_WIDTH/2,CANVAS_HEIGHT-450,v,s_oStage);d.addEventListener(ON_MOUSE_UP,this._onButPlayRelease,this);d.pulseAnimation();v=s_oSpriteLibrary.getSprite("but_credits");c=10+v.width/2;a=v.height/2+25;l=new CGfxButton(c,a,v,s_oStage);l.addEventListener(ON_MOUSE_UP,this._onCredits,this);
if(!1===DISABLE_SOUND_MOBILE||!1===s_bMobile)v=s_oSpriteLibrary.getSprite("audio_icon"),g=CANVAS_WIDTH-v.height/2-10,h=v.height/2+25,k=new CToggle(g,h,v,s_bAudioActive,s_oStage),k.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this);v=window.document;var r=v.documentElement;q=r.requestFullscreen||r.mozRequestFullScreen||r.webkitRequestFullScreen||r.msRequestFullscreen;w=v.exitFullscreen||v.mozCancelFullScreen||v.webkitExitFullscreen||v.msExitFullscreen;!1===ENABLE_FULLSCREEN&&(q=!1);q&&screenfull.enabled&&
(v=s_oSpriteLibrary.getSprite("but_fullscreen"),f=c+v.width/2+10,e=a,p=new CToggle(f,e,v,s_bFullscreen,s_oStage),p.addEventListener(ON_MOUSE_UP,this._onFullscreenRelease,this));m=new createjs.Shape;m.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);s_oStage.addChild(m);createjs.Tween.get(m).to({alpha:0},1E3).call(function(){m.visible=!1});this.refreshButtonPos(s_iOffsetX,s_iOffsetY)};this.unload=function(){d.unload();d=null;m.visible=!1;if(!1===DISABLE_SOUND_MOBILE||!1===s_bMobile)k.unload(),
k=null;l.unload();q&&screenfull.enabled&&p.unload();s_oStage.removeChild(b);s_oMenu=b=null};this.refreshButtonPos=function(b,d){!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||k.setPosition(g-b,d+h);l.setPosition(c+b,d+a);q&&screenfull.enabled&&p.setPosition(f+b,d+e)};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=!s_bAudioActive};this._onButPlayRelease=function(){this.unload();$(s_oMain).trigger("start_session");s_oMain.gotoModeMenu()};this._onCredits=function(){new CCreditsPanel};
this.resetFullscreenBut=function(){p.setActive(s_bFullscreen)};this._onFullscreenRelease=function(){s_bFullscreen?w.call(window.document):q.call(window.document.documentElement);sizeHandler()};s_oMenu=this;this._init()}var s_oMenu=null;
function CModeMenu(){var g,h,f,e,c,a,b,d,m,k,l,p=null,q,w,v,r,B=null,A=null;this._init=function(){var b=createBitmap(s_oSpriteLibrary.getSprite("bg_mod_menu"));s_oStage.addChild(b);b=s_oSpriteLibrary.getSprite("but_exit");f=CANVAS_WIDTH-b.height/2-10;e=b.height/2+25;l=new CGfxButton(f,e,b,s_oStage);l.addEventListener(ON_MOUSE_UP,this._onExit,this);c=CANVAS_WIDTH-b.width/2-125;a=b.height/2+25;if(!1===DISABLE_SOUND_MOBILE||!1===s_bMobile)b=s_oSpriteLibrary.getSprite("audio_icon"),p=new CToggle(c,a,
b,s_bAudioActive,s_oStage),p.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this);b=window.document;var C=b.documentElement;B=C.requestFullscreen||C.mozRequestFullScreen||C.webkitRequestFullScreen||C.msRequestFullscreen;A=b.exitFullscreen||b.mozCancelFullScreen||b.webkitExitFullscreen||b.msExitFullscreen;!1===ENABLE_FULLSCREEN&&(B=!1);B&&screenfull.enabled&&(b=s_oSpriteLibrary.getSprite("but_fullscreen"),g=b.width/4+10,h=e,r=new CToggle(g,h,b,s_bFullscreen,s_oStage),r.addEventListener(ON_MOUSE_UP,
this._onFullscreenRelease,this));d=new createjs.Text(TEXT_MODE,"bold 80px "+PRIMARY_FONT,"#ffffff");d.x=CANVAS_WIDTH/2;d.y=400;d.textAlign="center";d.textBaseline="middle";d.lineWidth=600;s_oStage.addChild(d);b=s_oSpriteLibrary.getSprite("but_vs_man");m=new CGfxButton(CANVAS_WIDTH/2,800,b,s_oStage);m.addEventListener(ON_MOUSE_UP,this._onButHumanRelease,this);b=s_oSpriteLibrary.getSprite("message");C=createBitmap(b);C.regX=b.width/2;C.regY=b.height/2;C.x=CANVAS_WIDTH/2;C.y=1532;s_oStage.addChild(C);
b=s_oSpriteLibrary.getSprite("toggle_easy");q=new CToggle(CANVAS_WIDTH/2-130+2,1550,b,!1,s_oStage);q.addEventListenerWithParams(ON_MOUSE_UP,this._onDifficultyToggle,this,EASY_MODE);b=s_oSpriteLibrary.getSprite("toggle_medium");w=new CToggle(CANVAS_WIDTH/2+2,1550,b,!0,s_oStage);w.addEventListenerWithParams(ON_MOUSE_UP,this._onDifficultyToggle,this,MEDIUM_MODE);b=s_oSpriteLibrary.getSprite("toggle_hard");v=new CToggle(CANVAS_WIDTH/2+132,1550,b,!1,s_oStage);v.addEventListenerWithParams(ON_MOUSE_UP,this._onDifficultyToggle,
this,HARD_MODE);b=s_oSpriteLibrary.getSprite("but_vs_pc");k=new CGfxButton(CANVAS_WIDTH/2,1300,b,s_oStage);k.addEventListener(ON_MOUSE_UP,this._onButComputerRelease,this);this._onDifficultyToggle(MEDIUM_MODE);this.refreshButtonPos(s_iOffsetX,s_iOffsetY)};this.unload=function(){m.unload();k.unload();l.unload();if(!1===DISABLE_SOUND_MOBILE||!1===s_bMobile)p.unload(),p=null;B&&screenfull.enabled&&r.unload();s_oModeMenu=null;s_oStage.removeAllChildren()};this._onDifficultyToggle=function(a){switch(a){case EASY_MODE:q.setActive(!0);
w.setActive(!1);v.setActive(!1);b=EASY_MODE;SEARCH_DEPTH=1;break;case MEDIUM_MODE:q.setActive(!1);w.setActive(!0);v.setActive(!1);b=MEDIUM_MODE;SEARCH_DEPTH=2;break;case HARD_MODE:q.setActive(!1),w.setActive(!1),v.setActive(!0),b=HARD_MODE,SEARCH_DEPTH=3}};this.refreshButtonPos=function(b,d){l.setPosition(f-b,d+e);!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||p.setPosition(c-b,d+a);B&&screenfull.enabled&&r.setPosition(g+b,d+h)};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=
!s_bAudioActive};this.resetFullscreenBut=function(){r.setActive(s_bFullscreen)};this._onFullscreenRelease=function(){s_bFullscreen?A.call(window.document):B.call(window.document.documentElement);sizeHandler()};this._onExit=function(){this.unload();s_oMain.gotoMenu()};this._onButHumanRelease=function(){this.unload();s_oMain.gotoGame(MODE_HUMAN)};this._onButComputerRelease=function(){this.unload();s_oMain.gotoGame(MODE_COMPUTER,b)};s_oModeMenu=this;this._init()}var s_oModeMenu=null;
function CGame(g){var h,f,e,c,a,b,d,m,k,l,p,q=null,w,v,r,B,A,E=null,C,z,N;this._init=function(){h=!0;f=!1;e=PLAYER_STATE_WAIT;c=WHITE;b=a=k=0;m=d=START_SCORE;A=z=null;var g=createBitmap(s_oSpriteLibrary.getSprite("bg_game"));s_oStage.addChild(g);w=new createjs.Container;w.x=CANVAS_WIDTH/2;w.y=CANVAS_HEIGHT/2;w.scaleX=w.scaleY=1.2;s_oStage.addChild(w);v=new createjs.Container;s_oStage.addChild(v);r=new createjs.Container;r.x=CANVAS_WIDTH/2;r.y=CANVAS_HEIGHT/2;r.scaleX=r.scaleY=1.2;s_oStage.addChild(r);
B=new createjs.Container;B.x=CANVAS_WIDTH/2;B.y=CANVAS_HEIGHT/2;B.scaleX=B.scaleY=1.2;s_oStage.addChild(B);p=new CInterface(v);g=s_oSpriteLibrary.getSprite("board8");C=new createBitmap(g);C.regX=g.width/2;C.regY=g.height/2;w.addChild(C);this._initBoard();this.setPieceDepth();new CMovesController(l);new CMovesControllerFaster(l);new CBoardStateController;p.activePlayer(c);N=new CAI};this._initBoard=function(){var a=NUM_CELL,b=CELL_LENGTH,d=-BOARD_LENGTH/2+b/2;l=[];for(var c=0;c<a;c++){l[c]=[];for(var m=
0;m<a;m++)l[c][m]=new CCell(d+m*b,d+c*b,null,c,m,w,r,B)}for(c=0;c<a;c++)l[1][c].createPiece(k,BLACK,PAWN);for(c=0;c<a;c++)l[6][c].createPiece(k,WHITE,PAWN);l[0][0].createPiece(k,BLACK,ROOK);l[0][7].createPiece(k,BLACK,ROOK);l[7][0].createPiece(k,WHITE,ROOK);l[7][7].createPiece(k,WHITE,ROOK);l[0][1].createPiece(k,BLACK,KNIGHT);l[0][6].createPiece(k,BLACK,KNIGHT);l[7][1].createPiece(k,WHITE,KNIGHT);l[7][6].createPiece(k,WHITE,KNIGHT);l[0][2].createPiece(k,BLACK,BISHOP);l[0][5].createPiece(k,BLACK,BISHOP);
l[7][2].createPiece(k,WHITE,BISHOP);l[7][5].createPiece(k,WHITE,BISHOP);l[0][3].createPiece(k,BLACK,QUEEN);l[0][4].createPiece(k,BLACK,KING);l[7][3].createPiece(k,WHITE,QUEEN);l[7][4].createPiece(k,WHITE,KING)};this.changeTurn=function(){null!==A&&A.removeAnimated();f=!1;e=PLAYER_STATE_WAIT;if(c===WHITE){c=BLACK;var a=this.checkGameState();s_iGameType===MODE_COMPUTER&&this._playAI(a)}else c=WHITE,this.checkGameState();p.activePlayer(c)};this._playAI=function(a){if(!a){E=new CThinking;E.update();a=
MIN_AI_THINKING+Math.random()*(MAX_AI_THINKING-MIN_AI_THINKING);var b=N.getMove();null!==b&&setTimeout(function(){E.unload();E=null;s_oGame.cellClicked(b.sourcerow,b.sourcecol);s_oGame.cellClicked(b.destrow,b.destcol)},a)}};this.cellClicked=function(a,b){switch(e){case PLAYER_STATE_WAIT:this._disableAllThreat();if(null!==l[a][b].getColor()&&l[a][b].getColor()!==c)break;this._selectPiece(a,b);break;case PLAYER_STATE_SELECTED:z.getLogicPos().row===a&&z.getLogicPos().col===b?this._deselectPiece():l[a][b].getColor()===
c?(this._deselectPiece(),this._selectPiece(a,b)):l[a][b].isHighlight()?this._checkLegalMove(a,b):this._deselectPiece(),playSound("click",1,!1)}};this._checkLegalMove=function(a,b){var d=s_oBoardStateController.copyBoard(l);s_oBoardStateController.moveCopiedPiece(d,z.getLogicPos().row,z.getLogicPos().col,a,b);d=s_oBoardStateController.findAllChecks(c,d);if(0===d.length){switch(s_oBoardStateController.getSpecialMoves(z.getLogicPos().row,z.getLogicPos().col,a,b,l)){case BOARD_SPECIAL_CASTLING_RIGHT:var m=
l[z.getLogicPos().row][7];d=l[z.getLogicPos().row][5];m.shift(d);break;case BOARD_SPECIAL_CASTLING_LEFT:m=l[z.getLogicPos().row][0];d=l[z.getLogicPos().row][3];m.shift(d);break;case BOARD_SPECIAL_ENPASSANT:l[z.getLogicPos().row][b].eatUp()}z.setActive(!1);this._movePiece(a,b);this._deselectPiece();e=PLAYER_STATE_MOVING}else for(this._disableAllThreat(),m=0;m<d.length;m++)l[d[m].getLogicPos().row][d[m].getLogicPos().col].threat(!0)};this._movePiece=function(a,b){var d=l[a][b];z.move(d);null!==d.getColor()&&
d.eatUp()};this._selectPiece=function(a,b){z=l[a][b];z.setActive(!0);for(var d=s_oMovesController.getMovesList(a,b,l),c=0;c<d.length;c++)l[d[c].row][d[c].col].highlight(!0);e=PLAYER_STATE_SELECTED;playSound("click",1,!1)};this._deselectPiece=function(){this._disableAllHighlight();z.setActive(!1);z=null;e=PLAYER_STATE_WAIT};this.onFinishMove=function(){this.setPieceDepth();var a=s_oBoardStateController.checkPromotion(l);null===a?this.changeTurn():s_iGameType===MODE_HUMAN?new CPromoPanel(c,a):c===BLACK?
(this.changePiece(QUEEN,a),this.changeTurn()):new CPromoPanel(c,a)};this.checkGameState=function(){var a=!1;switch(s_oBoardStateController.getState(c,l)){case BOARD_STATE_STALEMATE:this.gameOver(DRAW);A=new CMessage(c,TEXT_STALEMATE);a=!0;break;case BOARD_STATE_CHECK:f=!0;for(var b=s_oBoardStateController.findAllChecks(c,l),d=0;d<b.length;d++)l[b[d].getLogicPos().row][b[d].getLogicPos().col].threat(!0);A=new CMessage(c,TEXT_CHECK);break;case BOARD_STATE_CHECKMATE:a=s_oBoardStateController.getOtherOpponent(c),
A=new CMessage(c,TEXT_CHECKMATE),this.gameOver(a),a=!0}return a};this.setPieceDepth=function(){for(var a=[],b=0;b<r.children.length;b++){var d=r.children[b];a.push({height:d.y,piece:d})}a.sort(this.compareHeight);for(b=d=0;b<r.children.length;b++)r.setChildIndex(a[b].piece,d++)};this.compareHeight=function(a,b){return a.height<b.height?-1:a.height>b.height?1:0};this.getCells=function(){return l};this.restartGame=function(){this.unload();this._init()};this.pauseGame=function(a){h=!a};this.unload=function(){h=
!1;p.unload();null!==q&&q.unload();createjs.Tween.removeAllTweens();s_oStage.removeAllChildren()};this._disableAllHighlight=function(){null!==z&&z.setActive(!1);for(var a=0;a<NUM_CELL;a++)for(var b=0;b<NUM_CELL;b++)l[a][b].highlight(!1),l[a][b].threat(!1)};this._disableAllThreat=function(){for(var a=0;a<NUM_CELL;a++)for(var b=0;b<NUM_CELL;b++)l[a][b].threat(!1)};this.setAllVisible=function(a){for(var b=0;b<NUM_CELL;b++)for(var d=0;d<NUM_CELL;d++)l[b][d].setVisible(a)};this.isCheck=function(){return f};
this.onExitPromoPanel=function(){this.changeTurn()};this.changePiece=function(a,b){l[b.row][b.col].changePiece(c,a)};this.getNewHistoryID=function(){return++k};this.onExit=function(){$(s_oMain).trigger("end_session");$(s_oMain).trigger("show_interlevel_ad");s_oGame.unload();s_oMain.gotoMenu()};this._onExitHelp=function(){h=!0};this.gameOver=function(c){h=!1;c===WHITE?d=0:c===BLACK?m=0:c===DRAW&&(m=d=0);q=new CEndPanel(s_oSpriteLibrary.getSprite("msg_box"));setTimeout(function(){q.show(c,a,b,d,m);
p.setInfoVisible(!1)},1E3)};this.update=function(){h&&(null!==E&&E.update(),this.setPieceDepth(),c===WHITE?(b+=s_iTimeElaps,p.refreshWhiteTime(b),m-=SCORE_DECREASE_PER_SECOND*s_iTimeElaps/1E3,0>m&&(m=0),p.refreshWhiteScore(Math.floor(m))):(a+=s_iTimeElaps,p.refreshBlackTime(a),d-=SCORE_DECREASE_PER_SECOND*s_iTimeElaps/1E3,0>d&&(d=0),p.refreshBlackScore(Math.floor(d))))};SHOW_SCORE=g.show_score;START_SCORE=g.start_score;SCORE_DECREASE_PER_SECOND=g.score_decrease_per_second;s_oGame=this;this._init()}
var s_oGame;
function CInterface(g){var h,f,e,c,a,b,d,m,k,l,p,q=null,w=null;this._init=function(g){var r=s_oSpriteLibrary.getSprite("but_exit");e=CANVAS_WIDTH-r.height/2-10;c=r.height/2+25;d=new CGfxButton(e,c,r,s_oStage);d.addEventListener(ON_MOUSE_UP,this._onExit,this);var v=CANVAS_WIDTH-r.width/2-125;if(!1===DISABLE_SOUND_MOBILE||!1===s_bMobile)r=s_oSpriteLibrary.getSprite("audio_icon"),h=v,f=25+r.height/2,m=new CToggle(h,f,r,s_bAudioActive,s_oStage),m.addEventListener(ON_MOUSE_UP,this._onAudioToggle,this);
v=window.document;r=v.documentElement;q=r.requestFullscreen||r.mozRequestFullScreen||r.webkitRequestFullScreen||r.msRequestFullscreen;w=v.exitFullscreen||v.mozCancelFullScreen||v.webkitExitFullscreen||v.msExitFullscreen;!1===ENABLE_FULLSCREEN&&(q=!1);q&&screenfull.enabled&&(r=s_oSpriteLibrary.getSprite("but_fullscreen"),a=r.width/4+10,b=r.height/2+25,p=new CToggle(a,b,r,s_bFullscreen,s_oStage),p.addEventListener(ON_MOUSE_UP,this._onFullscreenRelease,this));k=new CInfoTurn(950,1570,WHITE,g);l=new CInfoTurn(s_iGameType===
MODE_HUMAN&&s_bMobile?330:310,350,BLACK,g);this.refreshButtonPos(s_iOffsetX,s_iOffsetY)};this.unload=function(){d.unload();!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||m.unload();l.unload();k.unload();q&&screenfull.enabled&&p.unload();s_oInterface=null};this.refreshButtonPos=function(k,l){d.setPosition(e-k,l+c);!1!==DISABLE_SOUND_MOBILE&&!1!==s_bMobile||m.setPosition(h-k,l+f);q&&screenfull.enabled&&p.setPosition(a+k,l+b)};this.refreshWhiteTime=function(a){50<a&&k.refreshTime(formatTime(a))};this.refreshBlackTime=
function(a){50<a&&l.refreshTime(formatTime(a))};this.refreshWhiteScore=function(a){k.refreshScore(a)};this.refreshBlackScore=function(a){l.refreshScore(a)};this.activePlayer=function(a){a===WHITE?(l.active(!1),k.active(!0)):(k.active(!1),l.active(!0))};this.setInfoVisible=function(a){k.setPanelVisible(a);l.setPanelVisible(a)};this._onButConfigRelease=function(){new CConfigPanel};this._onButRestartRelease=function(){s_oGame.restartGame()};this.onExitFromHelp=function(){null.unload()};this._onExit=
function(){new CAreYouSurePanel(s_oGame.onExit)};this._onAudioToggle=function(){Howler.mute(s_bAudioActive);s_bAudioActive=!s_bAudioActive};this.resetFullscreenBut=function(){p.setActive(s_bFullscreen)};this._onFullscreenRelease=function(){s_bFullscreen?w.call(window.document):q.call(window.document.documentElement);sizeHandler()};s_oInterface=this;this._init(g);return this}var s_oInterface=null;
function CInfoTurn(g,h,f,e){var c,a,b,d,m,k,l;this._init=function(f,e,g,h){c=new createjs.Container;c.x=f;c.y=e;s_iGameType===MODE_HUMAN&&g===BLACK&&s_bMobile&&(c.rotation=180);h.addChild(c);k=new createjs.Container;f=-324;e=30;g===WHITE?(k.x=f,k.y=-e):(k.x=-f+20,s_iGameType===MODE_HUMAN&&g===BLACK&&s_bMobile?(k.x=f,k.y=-e):k.y=e);c.addChild(k);if(!SHOW_SCORE||s_iGameType===MODE_COMPUTER&&g===BLACK)k.visible=!1;f=s_oSpriteLibrary.getSprite("score_panel");e=createBitmap(f);e.regX=f.width/2;e.regY=
f.height/2;k.addChild(e);l=new createjs.Text(START_SCORE," 30px "+PRIMARY_FONT,"#ffffff");l.x=90;l.textAlign="right";l.textBaseline="middle";l.lineWidth=200;k.addChild(l);f=s_oSpriteLibrary.getSprite("bg_turn");e=new createjs.SpriteSheet({images:[f],framerate:58,frames:{width:f.width/2,height:f.height,regX:f.width/2/2,regY:f.height/2},animations:{off:[0,0,"on"],on:[1,1,"off"]}});a=createSprite(e,0,f.width/2/2,f.height/2,f.width/2,f.height);a.stop();c.addChild(a);b=createSprite(e,1,f.width/2/2,f.height/
2,f.width/2,f.height);b.stop();b.x=10;b.alpha=0;c.addChild(b);f=s_oSpriteLibrary.getSprite(g+"_king_marker");m=createBitmap(f);m.x=160;m.regX=f.width/2;m.regY=f.height/2;c.addChild(m);d=new createjs.Text("00:00"," 58px "+PRIMARY_FONT,"#ffffff");d.x=-65;d.y=2;d.textBaseline="middle";d.lineWidth=200;c.addChild(d)};this.refreshTime=function(a){d.text=a};this.refreshScore=function(a){l.text=a};this.invert=function(){d.x=0;m.x=-100};this.active=function(d){d?(createjs.Tween.get(a).to({alpha:0},750,createjs.Ease.cubicOut).to({alpha:1},
750,createjs.Ease.cubicIn).call(function(){p.active(d)}),createjs.Tween.get(b).to({alpha:1},750,createjs.Ease.cubicOut).to({alpha:0},750,createjs.Ease.cubicIn)):(a.alpha=1,b.alpha=0,createjs.Tween.removeTweens(a),createjs.Tween.removeTweens(b))};this.unload=function(){e.removeChild(c)};this.setBgVisible=function(b){a.visible=b;k.visible=b};this.setPanelVisible=function(a){c.visible=a};this.setPawn=function(a){m.gotoAndStop(a)};var p=this;this._init(g,h,f,e)}
function CThinking(){var g,h,f,e,c,a,b;this._init=function(){g=!0;h=0;f=new createjs.Container;var d=(new createjs.Graphics).beginFill("rgba(0,0,0,0.3)").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);a=new createjs.Shape(d);b=a.on("click",function(){});e=new createjs.Text(TEXT_THINKING,"bold 60px "+PRIMARY_FONT,"#ffffff");e.x=.5*CANVAS_WIDTH;e.y=.5*CANVAS_HEIGHT-100;e.textAlign="center";e.textBaseline="alphabetic";e.lineWidth=800;c=new createjs.Text("","bold 180px "+PRIMARY_FONT,"#ffffff");c.x=.5*CANVAS_WIDTH-
76;c.y=.5*CANVAS_HEIGHT-50;c.textAlign="left";c.textBaseline="alphabetic";c.lineWidth=800;f.addChild(a,e,c);s_oStage.addChild(f)};this.unload=function(){g=!1;a.off("click",b);s_oStage.removeChild(f)};this.update=function(){g&&(h+=s_iTimeElaps,0<=h&&h<TIME_LOOP_WAIT/4?c.text="":h>=TIME_LOOP_WAIT/4&&h<2*TIME_LOOP_WAIT/4?c.text=".":h>=2*TIME_LOOP_WAIT/4&&h<3*TIME_LOOP_WAIT/4?c.text="..":h>=3*TIME_LOOP_WAIT/4&&h<TIME_LOOP_WAIT?c.text="...":h=0)};this._init()}
function CEndPanel(g){var h,f,e,c,a,b,d,m,k,l,p;this._init=function(g){s_oGame.pauseGame(!0);d=new createjs.Shape;d.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);d.alpha=.7;h=createBitmap(g);h.regX=g.width/2;h.regY=g.height/2;h.x=CANVAS_WIDTH/2;h.y=CANVAS_HEIGHT/2;a=new createjs.Text("","bold 90px "+PRIMARY_FONT,"#ffffff");a.x=CANVAS_WIDTH/2;a.y=CANVAS_HEIGHT/2-280;a.textAlign="center";a.textBaseline="alphabetic";a.lineWidth=800;b=new createjs.Text("","bold 40px "+PRIMARY_FONT,
"#ffffff");b.x=CANVAS_WIDTH/2;b.y=CANVAS_HEIGHT/2-230;b.textAlign="center";b.textBaseline="alphabetic";b.lineWidth=800;f=new createjs.Container;f.alpha=0;f.visible=!1;f.addChild(d,h,a,b);e=new CInfoTurn(CANVAS_WIDTH/2,1E3,BLACK,f);e.setBgVisible(!1);e.invert();c=new CInfoTurn(CANVAS_WIDTH/2,850,WHITE,f);c.setBgVisible(!1);c.invert();g=s_oSpriteLibrary.getSprite("but_restart");l=new CGfxButton(CANVAS_WIDTH/2-180,CANVAS_HEIGHT/2+250,g,f);l.addEventListener(ON_MOUSE_UP,this._onRestart,this);g=s_oSpriteLibrary.getSprite("but_home");
m=new CGfxButton(CANVAS_WIDTH/2,CANVAS_HEIGHT/2+250,g,f);m.addEventListener(ON_MOUSE_UP,this._onExit,this);g=s_oSpriteLibrary.getSprite("but_show");k=new CGfxButton(CANVAS_WIDTH/2+180,CANVAS_HEIGHT/2+250,g,f);k.addEventListener(ON_MOUSE_UP,this._onShow,this);s_oStage.addChild(f)};this.unload=function(){f.off("mousedown",p)};this._initListener=function(){p=f.on("mousedown",this._onExit)};this.show=function(d,m,k,l,g){e.refreshTime(formatTime(m));c.refreshTime(formatTime(k));d===WHITE?(playSound("win",
1,!1),a.text=TEXT_CHECKMATE,b.text=TEXT_WINS.format(WHITE)):d===BLACK?(s_iGameType===MODE_HUMAN?playSound("win",1,!1):playSound("game_over",1,!1),a.text=TEXT_CHECKMATE,b.text=TEXT_WINS.format(BLACK)):d===DRAW&&(playSound("game_over",1,!1),a.text=TEXT_STALEMATE,b.text=DRAW);f.visible=!0;createjs.Tween.get(f).to({alpha:1},500);$(s_oMain).trigger("save_score",[d,m,k,s_iGameType,g,l]);$(s_oMain).trigger("share_event",[g,s_iGameType,d])};this._onRestart=function(){s_oGame.restartGame()};this._onExit=function(){f.off("mousedown",
p);e.unload();c.unload();s_oStage.removeChild(f);m.unload();k.unload();$(s_oMain).trigger("end_session");$(s_oMain).trigger("show_interlevel_ad");s_oGame.onExit()};this._onShow=function(){f.visible=!1;$(s_oMain).trigger("end_session")};this._init(g);return this}
function CCell(g,h,f,e,c,a,b,d){var m,k,l,p,q,w,v,r;this._init=function(a,b,d,c,f,e,g,h){m=c;k=f;l=new createjs.Container;l.x=a;l.y=b;e.addChild(l);p=null;a=s_oSpriteLibrary.getSprite("highlight");v=createBitmap(a);v.regX=a.width/2;v.regY=a.height/2;v.alpha=.8;v.visible=!1;l.addChild(v);a=s_oSpriteLibrary.getSprite("threat");w=createBitmap(a);w.regX=a.width/2;w.regY=a.height/2;w.visible=!1;l.addChild(w);q=new createjs.Shape;q.graphics.beginFill("rgba(158,0,0,0.01)").drawRect(-CELL_LENGTH/2,-CELL_LENGTH/
2,CELL_LENGTH,CELL_LENGTH);r=q.on("mousedown",this._onCellClick);l.addChild(q)};this.unload=function(){a.removeChild(l);q.off("mousedown",r)};this.setClickableArea=function(a){q.visible=a};this.changePiece=function(a,m){var k=p.getHistory();p.unload();p=new CPiece(g,h,a,m,b,d);p.setHistory(k);p.setNewMoveInHistory(s_oGame.getNewHistoryID(),e,c,m)};this.createPiece=function(a,m,k){p=new CPiece(g,h,m,k,b,d);p.setNewMoveInHistory(a,e,c,k)};this.getPieceContainer=function(){return p.getContainer()};this.setPiece=
function(a){p=a};this.getType=function(){return null!==p?p.getType():null};this.getColor=function(){return null!==p?p.getColor():null};this.getPieceHistory=function(){return null!==p?p.getHistory():[]};this.threat=function(a){w.visible=a};this.highlight=function(a){v.visible=a};this.isHighlight=function(){return v.visible};this._onCellClick=function(){s_oGame.cellClicked(m,k)};this.setActive=function(a){null!==p&&p.setActive(a)};this.setVisible=function(a){l.visible=a};this.getPos=function(){return{x:g,
y:h}};this.getLogicPos=function(){return{row:e,col:c}};this.move=function(a){p.move(a);p=null};this.shift=function(a){p.shift(a);p=null};this.eatUp=function(){p.disappear()};this._init(g,h,f,e,c,a,b,d)}
function CPiece(g,h,f,e,c,a){var b,d,m,k;this._init=function(a,c,f,l,e,g){b=f;d=l;m=[];f=this._getSpriteName();f=s_oSpriteLibrary.getSprite(f);l=f.width/2;g=f.height;f=new createjs.SpriteSheet({images:[f],frames:{width:l,height:g,regX:l/2,regY:g-40},animations:{idle:[0],lit:[1]}});k=createSprite(f,"idle",0,0,0,0);k.x=a;k.y=c;e.addChild(k)};this.unload=function(){c.removeChild(k)};this._getSpriteName=function(){var a=f===WHITE?"white":"black";switch(e){case PAWN:var b="pawn";break;case ROOK:b="rook";
break;case KNIGHT:b="knight";break;case BISHOP:b="bishop";break;case QUEEN:b="queen";break;case KING:b="king"}return a+"_"+b};this.getContainer=function(){return k};this.getType=function(){return d};this.getColor=function(){return b};this.setPos=function(a,b){k.x=a;k.y=b};this.getPos=function(){return{x:k.x,y:k.y}};this.setNewMoveInHistory=function(a,b,d,c){m.push({id:a,row:b,col:d,piece:c})};this.setHistory=function(a){m=[];for(var b=0;b<a.length;b++)m[b]=a[b]};this.getHistory=function(){return m};
this.setActive=function(a){a?k.gotoAndStop("lit"):k.gotoAndStop("idle")};this.move=function(b){var m=b.getPos();d===KNIGHT?(a.addChild(k),(new createjs.Tween.get(k)).to({scaleX:1.3,scaleY:1.3},.4*TIME_MOVE,createjs.Ease.cubicOut).to({scaleX:1,scaleY:1},600)):d===PAWN&&s_oBoardStateController.resetStall();(new createjs.Tween.get(k)).to({x:m.x,y:m.y},TIME_MOVE,createjs.Ease.cubicOut).call(function(){s_oBoardStateController.increaseStallCount();d===KNIGHT&&c.addChild(k);b.setPiece(l);s_oGame.onFinishMove();
l.setNewMoveInHistory(s_oGame.getNewHistoryID(),b.getLogicPos().row,b.getLogicPos().col,d)})};this.shift=function(a){var b=a.getPos();(new createjs.Tween.get(k)).to({x:b.x,y:b.y},1E3,createjs.Ease.cubicOut).call(function(){a.setPiece(l);l.setNewMoveInHistory(s_oGame.getNewHistoryID(),a.getLogicPos().row,a.getLogicPos().col,d)})};this.disappear=function(){(new createjs.Tween.get(k)).to({alpha:0},1E3).call(function(){s_oBoardStateController.resetStall();l.unload()})};var l=this;this._init(g,h,f,e,c,
a)}var DIR_TOPRIGHT="DIR_TOPRIGHT",DIR_RIGHT="DIR_RIGHT",DIR_BOTRIGHT="DIR_BOTRIGHT",DIR_TOPLEFT="DIR_TOPLEFT",DIR_LEFT="DIR_LEFT",DIR_BOTLEFT="DIR_BOTLEFT",DIR_TOP="DIR_TOP",DIR_BOT="DIR_BOT";
function CMovesController(g){var h,f,e,c;this._init=function(a){h=a.length;f=a[0].length;c=[];e=[];for(a=0;a<h;a++){e[a]=[];for(var b=0;b<f;b++)e[a][b]=[]}this._buildMap()};this._buildMap=function(){for(var a=0;a<h;a++)for(var b=0;b<f;b++)e[a][b][DIR_TOPRIGHT]=this._setNeighbor(a,b,DIR_TOPRIGHT),e[a][b][DIR_RIGHT]=this._setNeighbor(a,b,DIR_RIGHT),e[a][b][DIR_BOTRIGHT]=this._setNeighbor(a,b,DIR_BOTRIGHT),e[a][b][DIR_TOPLEFT]=this._setNeighbor(a,b,DIR_TOPLEFT),e[a][b][DIR_LEFT]=this._setNeighbor(a,
b,DIR_LEFT),e[a][b][DIR_BOTLEFT]=this._setNeighbor(a,b,DIR_BOTLEFT),e[a][b][DIR_TOP]=this._setNeighbor(a,b,DIR_TOP),e[a][b][DIR_BOT]=this._setNeighbor(a,b,DIR_BOT)};this._setNeighbor=function(a,b,d){var c=null;switch(d){case DIR_TOPRIGHT:0<a&&b<f-1&&(c={row:a-1,col:b+1});break;case DIR_RIGHT:b<f-1&&(c={row:a,col:b+1});break;case DIR_BOTRIGHT:a<h-1&&b<f-1&&(c={row:a+1,col:b+1});break;case DIR_TOPLEFT:0<a&&0<b&&(c={row:a-1,col:b-1});break;case DIR_LEFT:0<b&&(c={row:a,col:b-1});break;case DIR_BOTLEFT:a<
h-1&&0<b&&(c={row:a+1,col:b-1});break;case DIR_TOP:0<a&&(c={row:a-1,col:b});break;case DIR_BOT:a<h-1&&(c={row:a+1,col:b})}return c};this._getNeighborByDir=function(a,b,d){return e[a][b][d]};this._getAllNeighbor=function(a,b){var d=[],c;for(c in e[a][b])null!==e[a][b][c]&&d.push(e[a][b][c]);return d};this._getMainDiagonal=function(a,b,d){var c=[],k=d[a][b].getColor();this._findInDirection(a,b,DIR_BOTRIGHT,c,99,k,d);this._findInDirection(a,b,DIR_TOPLEFT,c,99,k,d);return c};this._getSecondDiagonal=function(a,
b,d){var c=[],k=d[a][b].getColor();this._findInDirection(a,b,DIR_BOTLEFT,c,99,k,d);this._findInDirection(a,b,DIR_TOPRIGHT,c,99,k,d);return c};this._getRow=function(a,b,d){var c=[],k=d[a][b].getColor();this._findInDirection(a,b,DIR_LEFT,c,99,k,d);this._findInDirection(a,b,DIR_RIGHT,c,99,k,d);return c};this._getCol=function(a,b,d){var c=[],k=d[a][b].getColor();this._findInDirection(a,b,DIR_TOP,c,99,k,d);this._findInDirection(a,b,DIR_BOT,c,99,k,d);return c};this._getStraightByDirAndRadius=function(a,
b,d,m,k){var f=[];c=[];c.push({radius:m,direction:null});var e=k[a][b].getColor();this._findInDirection(a,b,d,f,m,e,k);return f};this._getStraightRowByRadius=function(a,b,d){var m=[];c=[];c.push({radius:d,direction:null});this._findInDirection(a,b,DIR_LEFT,m,d);this._findInDirection(a,b,DIR_RIGHT,m,d);return m};this._getStraightColByRadius=function(a,b,d){var m=[];c=[];c.push({radius:d,direction:null});this._findInDirection(a,b,DIR_TOP,m,d);this._findInDirection(a,b,DIR_BOT,m,d);return m};this._findInDirection=
function(a,b,d,m,k,f,g){--k;if(null!==e[a][b][d]&&0<=k){var l=e[a][b][d].row;a=e[a][b][d].col;f?(b=g[l][a].getColor(),b!==f&&(null===b?(m.push({row:l,col:a}),c.push({radius:k,direction:d}),this._findInDirection(l,a,d,m,k,f,g)):(m.push({row:l,col:a}),c.push({radius:k,direction:d})))):(m.push({row:l,col:a}),c.push({radius:k,direction:d}),this._findInDirection(l,a,d,m,k,f,g))}};this._findTPos=function(a,b,d){var c=[];a=e[a][b][d];null!==a&&(a=e[a.row][a.col][d],null!==a&&(c=d===DIR_TOP||d===DIR_BOT?
this._getStraightRowByRadius(a.row,a.col,1):this._getStraightColByRadius(a.row,a.col,1)));return c};this.getMovesList=function(a,b,d){var c=[];switch(d[a][b].getType()){case PAWN:c=this.getPawnMove(a,b,d);break;case ROOK:c=this.getRookMove(a,b,d);break;case KNIGHT:c=this.getKnightMove(a,b,d);break;case BISHOP:c=this.getBishopMove(a,b,d);break;case QUEEN:c=this.getQueenMove(a,b,d);break;case KING:c=this.getKingMove(a,b,d)}return c};this.getPawnMove=function(a,b,d){var c=d[a][b].getColor(),f=[];if(c===
WHITE){var l=6===a?this._getStraightByDirAndRadius(a,b,DIR_TOP,2,d):this._getStraightByDirAndRadius(a,b,DIR_TOP,1,d);var e=this._getNeighborByDir(a,b,DIR_TOPRIGHT);null!==e&&d[e.row][e.col].getColor()===BLACK&&f.push(e);e=this._getNeighborByDir(a,b,DIR_TOPLEFT);null!==e&&d[e.row][e.col].getColor()===BLACK&&f.push(e);if(3===a)for(a=this._getEnPassant(WHITE,a,b,d),b=0;b<a.length;b++)f.push(a[b])}else if(l=1===a?this._getStraightByDirAndRadius(a,b,DIR_BOT,2,d):this._getStraightByDirAndRadius(a,b,DIR_BOT,
1,d),e=this._getNeighborByDir(a,b,DIR_BOTRIGHT),null!==e&&d[e.row][e.col].getColor()===WHITE&&f.push(e),e=this._getNeighborByDir(a,b,DIR_BOTLEFT),null!==e&&d[e.row][e.col].getColor()===WHITE&&f.push(e),4===a)for(a=this._getEnPassant(BLACK,a,b,d),b=0;b<a.length;b++)f.push(a[b]);for(b=l.length-1;0<=b;b--)null!==d[l[b].row][l[b].col].getColor()&&d[l[b].row][l[b].col].getColor()!==c&&l.splice(b,1);for(b=0;b<f.length;b++)l.push(f[b]);return l};this.getRookMove=function(a,b,d){var c=this._getRow(a,b,d);
a=this._getCol(a,b,d);b=[];for(d=0;d<c.length;d++)b.push(c[d]);for(d=0;d<a.length;d++)b.push(a[d]);return b};this.getKnightMove=function(a,b,d){var c=[];c.push(this._findTPos(a,b,DIR_TOP));c.push(this._findTPos(a,b,DIR_RIGHT));c.push(this._findTPos(a,b,DIR_BOT));c.push(this._findTPos(a,b,DIR_LEFT));for(var f=[],e=0;e<c.length;e++)for(var g=0;g<c[e].length;g++)f.push(c[e][g]);a=d[a][b].getColor();for(e=f.length-1;0<=e;e--)d[f[e].row][f[e].col].getColor()===a&&f.splice(e,1);return f};this.getBishopMove=
function(a,b,d){var c=this._getMainDiagonal(a,b,d);a=this._getSecondDiagonal(a,b,d);b=[];for(d=0;d<c.length;d++)b.push(c[d]);for(d=0;d<a.length;d++)b.push(a[d]);return b};this.getQueenMove=function(a,b,d){var c=this.getRookMove(a,b,d);a=this.getBishopMove(a,b,d);b=[];for(d=0;d<c.length;d++)b.push(c[d]);for(d=0;d<a.length;d++)b.push(a[d]);return b};this.getKingMove=function(a,b,d){var c=this._getAllNeighbor(a,b);if(1===d[a][b].getPieceHistory().length&&!s_oGame.isCheck()){var f=!0;1===d[a][7].getPieceHistory().length?
(null!==d[a][6].getColor()&&(f=!1),null!==d[a][5].getColor()&&(f=!1)):f=!1;f&&c.push({row:a,col:6});f=!0;1===d[a][0].getPieceHistory().length?(null!==d[a][1].getColor()&&(f=!1),null!==d[a][2].getColor()&&(f=!1),null!==d[a][3].getColor()&&(f=!1)):f=!1;f&&c.push({row:a,col:2})}a=d[a][b].getColor();for(b=c.length-1;0<=b;b--)d[c[b].row][c[b].col].getColor()===a&&c.splice(b,1);return c};this._getEnPassant=function(a,b,d,c){var f=[],m=s_oBoardStateController.getOtherOpponent(a),e=this._getNeighborByDir(b,
d,DIR_RIGHT);if(null!==e&&(e=c[e.row][e.col],e.getColor()===m&&e.getType()===PAWN)){e=e.getPieceHistory();var g=c[b][d].getPieceHistory();2===e.length&&g[g.length-1].id<e[1].id&&(a===WHITE?f.push(this._getNeighborByDir(b,d,DIR_TOPRIGHT)):f.push(this._getNeighborByDir(b,d,DIR_BOTRIGHT)))}e=this._getNeighborByDir(b,d,DIR_LEFT);null!==e&&(e=c[e.row][e.col],e.getColor()===m&&e.getType()===PAWN&&(e=e.getPieceHistory(),g=c[b][d].getPieceHistory(),2===e.length&&g[g.length-1].id<e[1].id&&(a===WHITE?f.push(this._getNeighborByDir(b,
d,DIR_TOPLEFT)):f.push(this._getNeighborByDir(b,d,DIR_BOTLEFT)))));return f};this._init(g);s_oMovesController=this}var s_oMovesController;
function CBoardStateController(){var g;this._init=function(){g=0};this.getOtherOpponent=function(g){return g===WHITE?BLACK:WHITE};this.moveCopiedPiece=function(g,f,e,c,a){var b=g[f][e];g[c][a].setCell(b.getColor(),b.getType(),c,a,b.getPieceHistory());b.setCell(null,null,f,e,[])};this.copyBoard=function(g){for(var f=[],e=0;e<g.length;e++){f[e]=[];for(var c=0;c<g[e].length;c++)f[e][c]=new CCopiedCell(g[e][c])}return f};this.getState=function(g,f){if(0!==this.findAllChecks(g,f).length)return this.findCheckMate(g,
f)?BOARD_STATE_CHECKMATE:BOARD_STATE_CHECK;if(this.findStaleMate(g,f))return BOARD_STATE_STALEMATE};this.findCheckMate=function(g,f){for(var e=[],c=0;c<f.length;c++)for(var a=0;a<f[c].length;a++)f[c][a].getColor()===g&&e.push(f[c][a]);for(c=0;c<e.length;c++){var b=s_oMovesController.getMovesList(e[c].getLogicPos().row,e[c].getLogicPos().col,f);for(a=0;a<b.length;a++){var d=this.copyBoard(f);this.moveCopiedPiece(d,e[c].getLogicPos().row,e[c].getLogicPos().col,b[a].row,b[a].col);if(0===this.findAllChecks(g,
d).length)return!1}}return!0};this.findAllChecks=function(g,f){for(var e=this.getOtherOpponent(g),c=[],a=0;a<f.length;a++)for(var b=0;b<f[a].length;b++)f[a][b].getColor()===e&&c.push(f[a][b]);e=[];for(a=0;a<c.length;a++){var d=c[a].getLogicPos();e[a]={list:s_oMovesController.getMovesList(d.row,d.col,f),piece:c[a]}}c=[];for(a=0;a<e.length;a++)for(b=0;b<e[a].list.length;b++)d=e[a].list[b],f[d.row][d.col].getColor()===g&&f[d.row][d.col].getType()===KING&&c.push(e[a].piece);return c};this.findStaleMate=
function(h,f){var e=this.findCheckMate(h,f);if(!e){for(var c=[],a=[],b=0;b<f.length;b++)for(var d=0;d<f[b].length;d++)f[b][d].getColor()===WHITE&&a.push(f[b][d].getType()),f[b][d].getColor()===BLACK&&c.push(f[b][d].getType());if(1===c.length&&1===a.length)return!0;if(1===c.length&&2===a.length||2===c.length&&1===a.length)if(b=a.indexOf(BISHOP)&&c.indexOf(BISHOP),d=a.indexOf(KNIGHT)&&c.indexOf(KNIGHT),0<=b||0<=d)return!0;if(2===c.length&&2===a.length&&(b=a.indexOf(BISHOP)||c.indexOf(BISHOP),0<=b)){c=
[];for(b=0;b<f.length;b++)for(d=0;d<f[b].length;d++)f[b][d].getType()===BISHOP&&c.push((b+d)%2);if(c[0]===c[1])return!0}}g===DRAW_COUNTER&&(e=!0);return e};this.increaseStallCount=function(){g++};this.resetStall=function(){g=0};this.checkPromotion=function(g){for(var f=null,e=0;e<g.length;e++)g[0][e].getType()===PAWN?f={row:0,col:e}:g[7][e].getType()===PAWN&&(f={row:7,col:e});return f};this.getSpecialMoves=function(g,f,e,c,a){g=a[g][f].getType();if(g===KING){f-=c;if(-2===f)return BOARD_SPECIAL_CASTLING_RIGHT;
if(2===f)return BOARD_SPECIAL_CASTLING_LEFT}else if(g===PAWN&&f!==c&&null===a[e][c].getType())return BOARD_SPECIAL_ENPASSANT};this._init();s_oBoardStateController=this}var s_oBoardStateController;
function CCopiedCell(g){var h,f,e,c,a;this._init=function(b){h=b.getColor();f=b.getType();c=b.getLogicPos().row;a=b.getLogicPos().col;b=b.getPieceHistory();e=[];for(var d=0;d<b.length;d++)e[d]=b[d]};this.setCell=function(b,d,m,g,l){h=b;f=d;c=m;a=g;for(b=0;b<l.length;b++)e[b]=l[b]};this.setColor=function(a){h=a};this.setType=function(a){f=a};this.getColor=function(){return h};this.getType=function(){return f};this.getLogicPos=function(){return{row:c,col:a}};this.getPieceHistory=function(){return e};
this._init(g)}
function CPromoPanel(g,h){var f,e,c,a,b,d,m;this._init=function(g,k){a=new createjs.Shape;a.graphics.beginFill("black").drawRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);a.alpha=0;s_oStage.addChild(a);(new createjs.Tween.get(a)).to({alpha:.7},500);var l=s_oSpriteLibrary.getSprite("msg_box");d=new createjs.Container;d.y=CANVAS_HEIGHT+l.height/2;s_oStage.addChild(d);e=createBitmap(l);e.regX=l.width/2;e.regY=l.height/2;e.x=CANVAS_WIDTH/2;e.y=CANVAS_HEIGHT/2;d.addChild(e);b=new createjs.Shape;b.graphics.beginFill("#0f0f0f").drawRect(0,0,
CANVAS_WIDTH,CANVAS_HEIGHT);b.alpha=.01;m=b.on("click",function(){});d.addChild(b);c=new createjs.Text(TEXT_PROMOTION,"40px "+PRIMARY_FONT,"#402604");c.textAlign="center";c.textBaseline="alphabetic";c.x=CANVAS_WIDTH/2;c.y=CANVAS_HEIGHT/2-300;c.lineWidth=700;d.addChild(c);l=new createjs.Container;l.x=CANVAS_WIDTH/2;l.y=CANVAS_HEIGHT/2;d.addChild(l);var h=[];h[0]=BISHOP;h[1]=ROOK;h[2]=KNIGHT;h[3]=QUEEN;f=[];for(var p=0;p<h.length;p++){var r=s_oSpriteLibrary.getSprite(g+"_"+h[p]);f[p]=new CToggle(-200+
400/(h.length-1)*p,0,r,!0,l);f[p].addEventListenerWithParams(ON_MOUSE_UP,this._onPieceSelected,this,h[p])}(new createjs.Tween.get(d)).to({y:0},750,createjs.Ease.cubicOut)};this.unload=function(){b.off("click",m);s_oStage.removeChild(a);s_oStage.removeChild(d)};this._onPieceSelected=function(b){s_oGame.changePiece(b,h);b=s_oSpriteLibrary.getSprite("msg_box");b=CANVAS_HEIGHT+b.height/2;(new createjs.Tween.get(a)).to({alpha:0},500);(new createjs.Tween.get(d)).to({y:b},500,createjs.Ease.backIn).call(function(){k.unload();
s_oGame.onExitPromoPanel()})};this._init(g,h);var k=this}
function CAI(){var g,h,f,e,c;this._init=function(){};this.getMove=function(){var a=this._buildTree();a=c.getNode(a,1);return this._getBestNode(a)};this._getBestNode=function(a){if(0<a.length){for(var b=0;b<a.length;b++){var d=a[b].model.moves;this._makeMove(d);var c=s_oMovesControllerFaster.getState(WHITE,f);c===BOARD_STATE_CHECKMATE?a[b].model.rating+=.5:c===BOARD_STATE_STALEMATE&&(a[b].model.rating-=.5);this._unMakeMove(d)}d=a[0].model.rating;for(b=1;b<a.length;b++)a[b].model.rating>d&&(d=a[b].model.rating);
c=[];for(b=0;b<a.length;b++)a[b].model.rating===d&&c.push(a[b]);a=c[Math.floor(Math.random()*c.length)].model.moves}else a=null;return a};this._buildTree=function(){g=0;c=new CTreeDecision({rating:0,moves:[],depth:0});f=this._copyBoard(s_oGame.getCells());(new Date).getTime();h=this._maxi(0);(new Date).getTime();return h};this._alphaBetaMax=function(a,b,d){g++;if(d===SEARCH_DEPTH)return this._evaluateBoard();var e=this._findAllMoves(BLACK),k=e.moves;e=e.opponentlist;for(var l=k.length-1;0<=l;l--)if(this._makeMove(k[l]),
s_oMovesControllerFaster.isInCheck(BLACK,f,e))this._unMakeMove(k[l]),k.splice(l,1);else{var h=d+1;c.initNewNode(h);h=this._alphaBetaMin(a,b,h);c.addNode(d,h,k[l]);this._unMakeMove(k[l]);if(h>=b)return b;h>a&&(a=h)}return a};this._alphaBetaMin=function(a,b,d){g++;if(d===SEARCH_DEPTH)return this._evaluateBoard();var e=this._findAllMoves(WHITE),k=e.moves;e=e.opponentlist;for(var l=k.length-1;0<=l;l--)if(this._makeMove(k[l]),s_oMovesControllerFaster.isInCheck(WHITE,f,e))this._unMakeMove(k[l]),k.splice(l,
1);else{var h=d+1;c.initNewNode(h);h=this._alphaBetaMax(a,b,h);c.addNode(d,h,k[l]);this._unMakeMove(k[l]);if(h<=a)return a;h<b&&(b=h)}return b};this._evaluateBoard=function(){return 200*(e[BLACK][KING]-e[WHITE][KING])+9*(e[BLACK][QUEEN]-e[WHITE][QUEEN])+5*(e[BLACK][ROOK]-e[WHITE][ROOK])+3*(e[BLACK][BISHOP]-e[WHITE][BISHOP]+e[BLACK][KNIGHT]-e[WHITE][KNIGHT])+(e[BLACK][PAWN]-e[WHITE][PAWN])};this._findAllMoves=function(a){for(var b=[],d=[],c=0;c<NUM_CELL;c++)for(var e=0;e<NUM_CELL;e++)if(null!==f[c][e].type)if(f[c][e].color===
a)for(var g=s_oMovesControllerFaster.getMovesList(c,e,f),h=0;h<g.length;h++){var q=g[h].row,w=g[h].col;b.push({sourcerow:c,sourcecol:e,destrow:q,destcol:w,sourcetype:f[c][e].type,sourcecolor:f[c][e].color,sourcehistory:f[c][e].history,desttype:f[q][w].type,destcolor:f[q][w].color,desthistory:f[q][w].history})}else d.push({row:c,col:e});return{moves:b,opponentlist:d}};this._makeMove=function(a){null!==a.destcolor&&e[a.destcolor][a.desttype]--;f[a.destrow][a.destcol]={color:a.sourcecolor,type:a.sourcetype,
history:a.sourcehistory};f[a.sourcerow][a.sourcecol]={color:null,type:null,history:[]};0!==a.destrow&&7!==a.destrow||a.sourcetype!==PAWN||(f[a.destrow][a.destcol]={color:a.sourcecolor,type:QUEEN,history:a.sourcehistory},e[a.sourcecolor][PAWN]--,e[a.sourcecolor][QUEEN]++)};this._unMakeMove=function(a){null!==a.destcolor&&e[a.destcolor][a.desttype]++;f[a.sourcerow][a.sourcecol]={color:a.sourcecolor,type:a.sourcetype,history:a.sourcehistory};f[a.destrow][a.destcol]={color:a.destcolor,type:a.desttype,
history:a.desthistory};0!==a.destrow&&7!==a.destrow||a.sourcetype!==PAWN||(e[a.sourcecolor][PAWN]++,e[a.sourcecolor][QUEEN]--)};this.debugBoard=function(a){for(var b=[],c=0;c<NUM_CELL;c++){b[c]=[];for(var e=0;e<NUM_CELL;e++)b[c][e]=a[c][e].getType()+"_"+a[c][e].getColor()}};this._copyBoard=function(a){e=[BLACK,WHITE];e[BLACK]=[];e[WHITE]=[];e[BLACK][KING]=0;e[BLACK][QUEEN]=0;e[BLACK][ROOK]=0;e[BLACK][BISHOP]=0;e[BLACK][KNIGHT]=0;e[BLACK][PAWN]=0;e[WHITE][KING]=0;e[WHITE][QUEEN]=0;e[WHITE][ROOK]=0;
e[WHITE][BISHOP]=0;e[WHITE][KNIGHT]=0;e[WHITE][PAWN]=0;for(var b=[],c=0;c<NUM_CELL;c++){b[c]=[];for(var f=0;f<NUM_CELL;f++)b[c][f]={color:a[c][f].getColor(),type:a[c][f].getType(),history:a[c][f].getPieceHistory()},null!==a[c][f].getColor()&&e[b[c][f].color][b[c][f].type]++}return b};this._maxi=function(a){if(a===SEARCH_DEPTH)return this._evaluateBoard();var b=-INFINITE,d=this._findAllMoves(BLACK),e=d.moves;d=d.opponentlist;for(var g=a+1,l=e.length-1;0<=l;l--)if(this._makeMove(e[l]),s_oMovesControllerFaster.isInCheck(BLACK,
f,d))this._unMakeMove(e[l]),e.splice(l,1);else{c.initNewNode(g);var h=this._mini(g);c.addNode(a,h,e[l]);this._unMakeMove(e[l]);h>b&&(b=h)}return b};this._mini=function(a){if(a===SEARCH_DEPTH)return this._evaluateBoard();var b=INFINITE,d=this._findAllMoves(WHITE),e=d.moves;d=d.opponentlist;for(var g=a+1,l=e.length-1;0<=l;l--)if(this._makeMove(e[l]),s_oMovesControllerFaster.isInCheck(WHITE,f,d))this._unMakeMove(e[l]),e.splice(l,1);else{c.initNewNode(g);var h=this._maxi(g);c.addNode(a,h,e[l]);this._unMakeMove(e[l]);
h<b&&(b=h)}return b};this._init()}DIR_TOPRIGHT="DIR_TOPRIGHT";DIR_RIGHT="DIR_RIGHT";DIR_BOTRIGHT="DIR_BOTRIGHT";DIR_TOPLEFT="DIR_TOPLEFT";DIR_LEFT="DIR_LEFT";DIR_BOTLEFT="DIR_BOTLEFT";DIR_TOP="DIR_TOP";DIR_BOT="DIR_BOT";
function CMovesControllerFaster(g){var h,f,e;this._init=function(c){h=c.length;f=c[0].length;e=[];for(c=0;c<h;c++){e[c]=[];for(var a=0;a<f;a++)e[c][a]=[]}this._buildMap()};this._buildMap=function(){for(var c=0;c<h;c++)for(var a=0;a<f;a++)e[c][a][DIR_TOPRIGHT]=this._setNeighbor(c,a,DIR_TOPRIGHT),e[c][a][DIR_RIGHT]=this._setNeighbor(c,a,DIR_RIGHT),e[c][a][DIR_BOTRIGHT]=this._setNeighbor(c,a,DIR_BOTRIGHT),e[c][a][DIR_TOPLEFT]=this._setNeighbor(c,a,DIR_TOPLEFT),e[c][a][DIR_LEFT]=this._setNeighbor(c,a,
DIR_LEFT),e[c][a][DIR_BOTLEFT]=this._setNeighbor(c,a,DIR_BOTLEFT),e[c][a][DIR_TOP]=this._setNeighbor(c,a,DIR_TOP),e[c][a][DIR_BOT]=this._setNeighbor(c,a,DIR_BOT)};this._setNeighbor=function(c,a,b){var d=null;switch(b){case DIR_TOPRIGHT:0<c&&a<f-1&&(d={row:c-1,col:a+1});break;case DIR_RIGHT:a<f-1&&(d={row:c,col:a+1});break;case DIR_BOTRIGHT:c<h-1&&a<f-1&&(d={row:c+1,col:a+1});break;case DIR_TOPLEFT:0<c&&0<a&&(d={row:c-1,col:a-1});break;case DIR_LEFT:0<a&&(d={row:c,col:a-1});break;case DIR_BOTLEFT:c<
h-1&&0<a&&(d={row:c+1,col:a-1});break;case DIR_TOP:0<c&&(d={row:c-1,col:a});break;case DIR_BOT:c<h-1&&(d={row:c+1,col:a})}return d};this._getNeighborByDir=function(c,a,b){return e[c][a][b]};this._getAllNeighbor=function(c,a){var b=[],d;for(d in e[c][a])null!==e[c][a][d]&&b.push(e[c][a][d]);return b};this._getMainDiagonal=function(c,a,b){var d=[],e=b[c][a].color;this._findInDirection(c,a,DIR_BOTRIGHT,d,99,e,b);this._findInDirection(c,a,DIR_TOPLEFT,d,99,e,b);return d};this._getSecondDiagonal=function(c,
a,b){var d=[],e=b[c][a].color;this._findInDirection(c,a,DIR_BOTLEFT,d,99,e,b);this._findInDirection(c,a,DIR_TOPRIGHT,d,99,e,b);return d};this._getRow=function(c,a,b){var d=[],e=b[c][a].color;this._findInDirection(c,a,DIR_LEFT,d,99,e,b);this._findInDirection(c,a,DIR_RIGHT,d,99,e,b);return d};this._getCol=function(c,a,b){var d=[],e=b[c][a].color;this._findInDirection(c,a,DIR_TOP,d,99,e,b);this._findInDirection(c,a,DIR_BOT,d,99,e,b);return d};this._getStraightByDirAndRadius=function(c,a,b,d,e){var f=
[];this._findInDirection(c,a,b,f,d,e[c][a].color,e);return f};this._getStraightRowByRadius=function(c,a,b){var d=[];this._findInDirection(c,a,DIR_LEFT,d,b);this._findInDirection(c,a,DIR_RIGHT,d,b);return d};this._getStraightColByRadius=function(c,a,b){var d=[];this._findInDirection(c,a,DIR_TOP,d,b);this._findInDirection(c,a,DIR_BOT,d,b);return d};this._findInDirection=function(c,a,b,d,f,g,l){--f;if(null!==e[c][a][b]&&0<=f){var k=e[c][a][b].row;c=e[c][a][b].col;g?(a=l[k][c].color,a!==g&&(null===a?
(d.push({row:k,col:c}),this._findInDirection(k,c,b,d,f,g,l)):d.push({row:k,col:c}))):(d.push({row:k,col:c}),this._findInDirection(k,c,b,d,f,g,l))}};this._findTPos=function(c,a,b){var d=[];c=e[c][a][b];null!==c&&(c=e[c.row][c.col][b],null!==c&&(d=b===DIR_TOP||b===DIR_BOT?this._getStraightRowByRadius(c.row,c.col,1):this._getStraightColByRadius(c.row,c.col,1)));return d};this.getMovesList=function(c,a,b){var d=[];switch(b[c][a].type){case PAWN:d=this.getPawnMove(c,a,b);break;case ROOK:d=this.getRookMove(c,
a,b);break;case KNIGHT:d=this.getKnightMove(c,a,b);break;case BISHOP:d=this.getBishopMove(c,a,b);break;case QUEEN:d=this.getQueenMove(c,a,b);break;case KING:d=this.getKingMove(c,a,b)}return d};this.getPawnMove=function(c,a,b){var d=b[c][a].color,e=[];if(d===WHITE){var f=6===c?this._getStraightByDirAndRadius(c,a,DIR_TOP,2,b):this._getStraightByDirAndRadius(c,a,DIR_TOP,1,b);var g=this._getNeighborByDir(c,a,DIR_TOPRIGHT);null!==g&&b[g.row][g.col].color===BLACK&&e.push(g);g=this._getNeighborByDir(c,a,
DIR_TOPLEFT);null!==g&&b[g.row][g.col].color===BLACK&&e.push(g);if(3===c)for(c=this._getEnPassant(WHITE,c,a,b),a=0;a<c.length;a++)e.push(c[a])}else if(f=1===c?this._getStraightByDirAndRadius(c,a,DIR_BOT,2,b):this._getStraightByDirAndRadius(c,a,DIR_BOT,1,b),g=this._getNeighborByDir(c,a,DIR_BOTRIGHT),null!==g&&b[g.row][g.col].color===WHITE&&e.push(g),g=this._getNeighborByDir(c,a,DIR_BOTLEFT),null!==g&&b[g.row][g.col].color===WHITE&&e.push(g),4===c)for(c=this._getEnPassant(BLACK,c,a,b),a=0;a<c.length;a++)e.push(c[a]);
for(a=f.length-1;0<=a;a--)null!==b[f[a].row][f[a].col].color&&b[f[a].row][f[a].col].color!==d&&f.splice(a,1);for(a=0;a<e.length;a++)f.push(e[a]);return f};this.getRookMove=function(c,a,b){var d=this._getRow(c,a,b);c=this._getCol(c,a,b);a=[];for(b=0;b<d.length;b++)a.push(d[b]);for(b=0;b<c.length;b++)a.push(c[b]);return a};this.getKnightMove=function(c,a,b){var d=[];d.push(this._findTPos(c,a,DIR_TOP));d.push(this._findTPos(c,a,DIR_RIGHT));d.push(this._findTPos(c,a,DIR_BOT));d.push(this._findTPos(c,
a,DIR_LEFT));for(var e=[],f=0;f<d.length;f++)for(var g=0;g<d[f].length;g++)e.push(d[f][g]);c=b[c][a].color;for(f=e.length-1;0<=f;f--)b[e[f].row][e[f].col].color===c&&e.splice(f,1);return e};this.getBishopMove=function(c,a,b){var d=this._getMainDiagonal(c,a,b);c=this._getSecondDiagonal(c,a,b);a=[];for(b=0;b<d.length;b++)a.push(d[b]);for(b=0;b<c.length;b++)a.push(c[b]);return a};this.getQueenMove=function(c,a,b){var d=this.getRookMove(c,a,b);c=this.getBishopMove(c,a,b);a=[];for(b=0;b<d.length;b++)a.push(d[b]);
for(b=0;b<c.length;b++)a.push(c[b]);return a};this.getKingMove=function(c,a,b){var d=this._getAllNeighbor(c,a);if(1===b[c][a].history.length&&!s_oGame.isCheck()){var e=!0;1===b[c][7].history.length?(null!==b[c][6].color&&(e=!1),null!==b[c][5].color&&(e=!1)):e=!1;e&&d.push({row:c,col:6});e=!0;1===b[c][0].history.length?(null!==b[c][1].color&&(e=!1),null!==b[c][2].color&&(e=!1),null!==b[c][3].color&&(e=!1)):e=!1;e&&d.push({row:c,col:2})}c=b[c][a].color;for(a=d.length-1;0<=a;a--)b[d[a].row][d[a].col].color===
c&&d.splice(a,1);return d};this._getEnPassant=function(c,a,b,d){var e=[],f=s_oBoardStateController.getOtherOpponent(c),g=this._getNeighborByDir(a,b,DIR_RIGHT);null!==g&&(g=d[g.row][g.col],g.color===f&&g.type===PAWN&&(g=g.history,2===g.length&&(c===WHITE?e.push(this._getNeighborByDir(a,b,DIR_TOPRIGHT)):e.push(this._getNeighborByDir(a,b,DIR_BOTRIGHT)))));g=this._getNeighborByDir(a,b,DIR_LEFT);null!==g&&(g=d[g.row][g.col],g.color===f&&g.type===PAWN&&(g=g.history,2===g.length&&(c===WHITE?e.push(this._getNeighborByDir(a,
b,DIR_TOPLEFT)):e.push(this._getNeighborByDir(a,b,DIR_BOTLEFT)))));return e};this.getState=function(c,a){if(0!==this.findAllChecks(c,a).length)return this.findCheckMate(c,a)?BOARD_STATE_CHECKMATE:BOARD_STATE_CHECK;if(this.findStaleMate(c,a))return BOARD_STATE_STALEMATE};this.findCheckMate=function(c,a){for(var b=[],d=0;d<a.length;d++)for(var e=0;e<a[d].length;e++)a[d][e].color===c&&b.push({row:d,col:e});for(d=0;d<b.length;d++){var f=b[d].row,g=b[d].col,h=s_oMovesControllerFaster.getMovesList(f,g,
a);for(e=0;e<h.length;e++){var q=h[e].row,w=h[e].col;q={sourcerow:f,sourcecol:g,destrow:q,destcol:w,sourcetype:a[f][g].type,sourcecolor:a[f][g].color,sourcehistory:a[f][g].history,desttype:a[q][w].type,destcolor:a[q][w].color,desthistory:a[q][w].history};this._makeMove(a,q);if(0===this.findAllChecks(c,a).length)return!1;this._unMakeMove(a,q)}}return!0};this._makeMove=function(c,a){c[a.destrow][a.destcol]={color:a.sourcecolor,type:a.sourcetype,history:a.sourcehistory};c[a.sourcerow][a.sourcecol]={color:null,
type:null,history:[]};0!==a.destrow&&7!==a.destrow||a.sourcetype!==PAWN||(c[a.destrow][a.destcol]={color:a.sourcecolor,type:QUEEN,history:a.sourcehistory})};this._unMakeMove=function(c,a){c[a.sourcerow][a.sourcecol]={color:a.sourcecolor,type:a.sourcetype,history:a.sourcehistory};c[a.destrow][a.destcol]={color:a.destcolor,type:a.desttype,history:a.desthistory}};this.findStaleMate=function(c,a){var b=this.findCheckMate(c,a);if(!b){for(var d=[],e=[],f=0;f<a.length;f++)for(var g=0;g<a[f].length;g++)a[f][g].color===
WHITE&&e.push(a[f][g].type),a[f][g].color===BLACK&&d.push(a[f][g].type);if(1===d.length&&1===e.length)return!0;if(1===d.length&&2===e.length||2===d.length&&1===e.length)if(f=e.indexOf(BISHOP)&&d.indexOf(BISHOP),g=e.indexOf(KNIGHT)&&d.indexOf(KNIGHT),0<=f||0<=g)return!0;if(2===d.length&&2===e.length&&(f=e.indexOf(BISHOP)||d.indexOf(BISHOP),0<=f)){d=[];for(f=0;f<a.length;f++)for(g=0;g<a[f].length;g++)a[f][g].type===BISHOP&&d.push((f+g)%2);if(d[0]===d[1])return!0}}return b};this.isInCheck=function(c,
a,b){for(var d,e=0;e<b.length;e++){d=s_oMovesControllerFaster.getMovesList(b[e].row,b[e].col,a);for(var f=0;f<d.length;f++){var g=d[f];if(a[g.row][g.col].color===c&&a[g.row][g.col].type===KING)return!0}}return!1};this.findAllChecks=function(c,a){for(var b=s_oBoardStateController.getOtherOpponent(c),d=[],e=0;e<a.length;e++)for(var f=0;f<a[e].length;f++)a[e][f].color===b&&d.push({row:e,col:f});b=[];for(e=0;e<d.length;e++){var g=d[e];b[e]={list:s_oMovesControllerFaster.getMovesList(g.row,g.col,a),piece:d[e]}}d=
[];for(e=0;e<b.length;e++)for(f=0;f<b[e].list.length;f++)g=b[e].list[f],a[g.row][g.col].color===c&&a[g.row][g.col].type===KING&&d.push(b[e].piece);return d};this._init(g);s_oMovesControllerFaster=this}var s_oMovesControllerFaster;